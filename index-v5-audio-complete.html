<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SafeMeet v5.0 - Personal Safety App (API Version)</title>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="datetime-local"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0085CA;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 133, 202, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            display: inline-block;
            margin-right: 5px;
        }

        .btn-link {
            background: none;
            color: #0085CA;
            text-decoration: underline;
            padding: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }

        .tab.active {
            background: white;
            color: #0085CA;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab.alert-active {
            background: #ff4757 !important;
            color: white !important;
            animation: pulse-urgent 1.5s infinite;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.8);
        }

        .tab.alert-active.active {
            background: #ff4757 !important;
            color: white !important;
        }

        .contact-card, .meeting-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #0085CA;
        }

        .contact-card h4, .meeting-card h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .contact-card p, .meeting-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .emergency-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ff4757;
            color: white;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 25px rgba(255, 71, 87, 0.5);
            animation: pulse 2s infinite;
            z-index: 1000;
            transition: all 0.3s;
        }

        .emergency-button.sos-active {
            background: #2ed573;
            animation: pulse-sos 2s infinite;
            box-shadow: 0 5px 25px rgba(46, 213, 115, 0.8);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 25px rgba(255, 71, 87, 0.5);
            }
            50% {
                box-shadow: 0 5px 35px rgba(255, 71, 87, 0.8);
            }
        }

        @keyframes pulse-sos {
            0%, 100% {
                box-shadow: 0 5px 25px rgba(46, 213, 115, 0.5);
            }
            50% {
                box-shadow: 0 5px 35px rgba(46, 213, 115, 0.8);
            }
        }

        @keyframes flashAlert {
            0%, 100% {
                background-color: #fee2e2;
                border-color: #dc2626;
            }
            50% {
                background-color: #fef2f2;
                border-color: #ef4444;
            }
        }

        .alert-badge {
            background: #ff4757;
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
            animation: flashAlert 0.8s infinite;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
            border: 2px solid #fff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            margin: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        /* MAP STYLES */
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            border: 2px solid #0085CA;
        }

        .map-info {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .map-info strong {
            color: #0085CA;
        }

        .location-status {
            background: #dcfce7;
            border: 2px solid #10b981;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .subscription-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .subscription-free {
            background: #e0e0e0;
            color: #666;
        }

        .subscription-monthly {
            background: #ffd93d;
            color: #333;
        }

        .subscription-annual {
            background: #6bcf7f;
            color: white;
        }

        .contact-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Dashboard Styles */
        .current-meeting-alert {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
        }

        .current-meeting-alert.show {
            display: flex;
        }

        .current-meeting-alert.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .current-meeting-alert.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: flashAlert 1.5s infinite;
        }

        .current-meeting-alert .indicator {
            margin-right: 15px;
        }

        .current-meeting-alert .content {
            flex: 1;
        }

        .current-meeting-alert h3 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .current-meeting-alert p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .meeting-status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-green {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-yellow {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }

        .status-red {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            animation: pulse-urgent 1s infinite;
        }

        @keyframes pulse-urgent {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-upcoming {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-ended {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-grace {
            background: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
            animation: flashAlert 1s infinite;
        }

        .alert-flash {
            animation: flashAlert 1s infinite;
            border: 3px solid #dc2626;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: #0085CA;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .settings-section h4 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .section-divider {
            border-top: 2px solid #e0e0e0;
            margin: 30px 0;
        }

        .comments-display {
            background: #f0f9ff;
            border-left: 4px solid #0085CA;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #333;
        }

        .comments-display strong {
            color: #0085CA;
            display: block;
            margin-bottom: 5px;
        }

        .editable-comments-box {
            background: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .editable-comments-box label {
            color: #92400e;
            font-size: 14px;
        }

        /* AUDIO CAPTURE STYLES */
        .audio-capture-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .audio-capture-box.recording {
            background: #fee2e2;
            border-color: #ef4444;
            animation: flashAlert 1.5s infinite;
        }

        .audio-capture-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .recording-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            margin-right: 10px;
            animation: pulse-urgent 1s infinite;
        }

        .transcription-display {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 8px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            color: #333;
            margin-top: 10px;
        }

        .transcription-display.empty {
            color: #999;
            font-style: italic;
        }

        .audio-file-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 12px;
            background: #0085CA;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
        }

        .audio-file-link:hover {
            background: #006da3;
        }

        /* SOS TAB STYLES */
        .sos-active-banner {
            background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sos-active-banner h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .sos-active-banner p {
            margin: 0;
            opacity: 0.9;
        }

        .sos-capture-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #2ed573;
        }

        .sos-capture-log h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .capture-entry {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .capture-entry .timestamp {
            font-weight: 600;
            color: #0085CA;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .capture-entry .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .capture-entry .transcription {
            font-size: 14px;
            color: #333;
            margin: 5px 0;
        }

        .capture-entry .location {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .emergency-button {
                width: 60px;
                height: 60px;
                font-size: 11px;
                bottom: 20px;
                right: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è SafeMeet</h1>
            <p>Your Personal Safety Companion v5.0 (API Version)</p>
            <div id="userInfo" style="margin-top: 10px; font-size: 12px;"></div>
        </div>

        <div class="content">
            <!-- Login/Register Screen -->
            <div id="authScreen" class="screen active">
                <div class="tabs">
                    <div class="tab active" onclick="switchAuthTab('login')">Login</div>
                    <div class="tab" onclick="switchAuthTab('register')">Register</div>
                </div>

                <div id="loginTab">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <button class="btn btn-link" onclick="showForgotPassword()">Forgot Password?</button>
                </div>

                <div id="registerTab" style="display:none;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="regPhone" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="Create password">
                    </div>
                    <div class="form-group">
                        <label>Subscription Plan</label>
                        <select id="regPlan">
                            <option value="free">Free - Emergency Contact Only</option>
                            <option value="monthly">Monthly - $10/month</option>
                            <option value="annual">Annual - $100/year</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="register()">Create Account</button>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #333;">Dashboard</h2>
                    <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
                </div>

                <!-- Current Meeting Status Alert -->
                <div id="currentMeetingAlert" class="current-meeting-alert">
                    <div class="indicator">
                        <div class="meeting-status-indicator" id="meetingStatusDot"></div>
                    </div>
                    <div class="content">
                        <h3 id="currentMeetingTitle"></h3>
                        <p id="currentMeetingDetails"></p>
                    </div>
                    <button class="btn btn-small" onclick="viewCurrentMeeting()" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white;">View</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchDashTab('meetings')">My Meetings</div>
                    <div class="tab" onclick="switchDashTab('monitoring')">Monitoring <span id="monitoringCount" style="display:none; background:#0085CA; color:white; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:5px;">0</span></div>
                    <div class="tab" onclick="switchDashTab('contacts')">Contacts</div>
                    <div class="tab" onclick="switchDashTab('alerts')">Alerts <span id="alertCount" class="alert-badge" style="display:none;">0</span></div>
                    <div class="tab" onclick="switchDashTab('sos')">SOS <span id="sosIndicator" style="display:none; background:#2ed573; color:white; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:5px;">ACTIVE</span></div>
                    <div class="tab" onclick="switchDashTab('settings')">Settings</div>
                </div>

                <!-- Meetings Tab -->
                <div id="meetingsTab">
                    <button class="btn btn-primary" onclick="showCreateMeeting()">+ Create New Meeting</button>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Upcoming Meetings</h3>
                    <div id="upcomingMeetingsList"><div class="loading">Loading...</div></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Past Meetings</h3>
                    <div id="pastMeetingsList"><div class="loading">Loading...</div></div>
                </div>

                <!-- Monitoring Tab -->
                <div id="monitoringTab" style="display:none;">
                    <div style="background: #e0f2fe; border-left: 4px solid #0085CA; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #0085CA; margin-bottom: 5px;">üëÅÔ∏è Meetings You're Monitoring</h4>
                        <p style="color: #666; font-size: 13px; margin: 0;">You've been added as an emergency contact for these meetings</p>
                    </div>
                    <div id="monitoringMeetingsList"><div class="loading">Loading...</div></div>
                </div>

                <!-- Contacts Tab -->
                <div id="contactsTab" style="display:none;">
                    <button class="btn btn-primary" onclick="showAddContact()">+ Add Emergency Contact</button>
                    <div id="contactsList"><div class="loading">Loading...</div></div>
                </div>

                <!-- Alerts Tab -->
                <div id="alertsTab" style="display:none;">
                    <div id="alertsList"><div class="loading">Loading...</div></div>
                </div>

                <!-- SOS Tab -->
                <div id="sosTab" style="display:none;">
                    <div id="sosActiveBanner" class="sos-active-banner" style="display:none;">
                        <h3>üÜò SOS ALERT ACTIVE</h3>
                        <p>Emergency alerts being sent to all contacts</p>
                        <p style="margin-top: 10px; font-size: 13px;">Audio capture occurs every 5 minutes</p>
                        <p style="margin-top: 5px; font-size: 13px;">Will auto-clear in <span id="sosTimeRemaining">15:00</span></p>
                        <button class="btn btn-danger btn-small" onclick="deactivateSOS()" style="margin-top: 15px;">Deactivate SOS</button>
                    </div>
                    
                    <div id="sosInactiveMessage" style="text-align: center; padding: 40px 20px; color: #666;">
                        <p>No active SOS alert</p>
                        <p style="font-size: 13px; margin-top: 10px;">Press the SOS button to activate emergency alerts</p>
                    </div>
                    
                    <div id="sosCaptureLog" style="display:none;">
                        <h3 style="color: #333; margin-bottom: 15px;">üìã SOS Alert History</h3>
                        <div id="sosCaptureEntries"></div>
                    </div>
                </div>

                <div id="settingsTab" style="display:none;">
                    <div class="settings-section">
                        <h3>‚öôÔ∏è Account Settings</h3>
                        <button class="btn btn-primary btn-small" onclick="showEditAccount()">‚úèÔ∏è Edit Account Info</button>
                        <button class="btn btn-warning btn-small" onclick="showChangePlan()">üí≥ Change Subscription Plan</button>
                    </div>

                    <div class="settings-section">
                        <h3>‚ÑπÔ∏è About</h3>
                        <p style="color: #666; font-size: 14px;">SafeMeet v5.0 - API Version with Backend Database</p>
                        <p style="color: #666; font-size: 14px;">Your Personal Safety Companion</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">Connected to: <span id="apiStatus">Checking...</span></p>
                    </div>
                </div>
            </div>

            <!-- Meeting Detail Screen -->
            <div id="meetingDetailScreen" class="screen">
                <button class="btn btn-secondary btn-small" onclick="backToDashboard()">‚Üê Back to Dashboard</button>
                <div id="meetingDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Emergency Button -->
    <button id="emergencyBtn" class="emergency-button" onclick="toggleSOS()" style="display:none;">
        SOS<br>HELP!
    </button>

    <!-- Modals -->
    <div id="createMeetingModal" class="modal">
        <div class="modal-content">
            <h2>Create Meeting</h2>
            <div class="form-group">
                <label>Person Meeting</label>
                <input type="text" id="meetingPerson" placeholder="Name">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="meetingLocation" placeholder="Address or place">
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="datetime-local" id="meetingStart">
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="datetime-local" id="meetingEnd">
            </div>
            <div class="form-group">
                <label>Comments (optional)</label>
                <textarea id="meetingComments" placeholder="Add any additional notes or special instructions..."></textarea>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableTracking">
                <label>Enable live location tracking</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableAudioCapture">
                <label>üé§ Enable emergency audio recording & transcription (60 seconds)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableSMS" checked>
                <label>Send SMS to emergency contacts</label>
            </div>
            <div class="form-group">
                <label>Select Emergency Contacts (min. 3)</label>
                <div id="contactCheckboxes"></div>
            </div>
            <button class="btn btn-primary" onclick="createMeeting()">Create Meeting</button>
            <button class="btn btn-secondary" onclick="closeModal('createMeetingModal')">Cancel</button>
        </div>
    </div>

    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <h2>Add Emergency Contact</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="contactName" placeholder="Contact name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="contactEmail" placeholder="contact@email.com">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="contactPhone" placeholder="+1 (555) 123-4567">
            </div>
            <div class="form-group">
                <label>Relationship</label>
                <input type="text" id="contactRelation" placeholder="Friend, Family, etc.">
            </div>
            <button class="btn btn-primary" onclick="addContact()">Add Contact</button>
            <button class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
        </div>
    </div>

    <div id="editAccountModal" class="modal">
        <div class="modal-content">
            <h2>Edit Account Information</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editName" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editPhone" placeholder="+1 (555) 123-4567">
            </div>
            <div class="form-group">
                <label>Change Password (leave blank to keep current)</label>
                <input type="password" id="editPassword" placeholder="New password">
            </div>
            <button class="btn btn-primary" onclick="saveAccountChanges()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editAccountModal')">Cancel</button>
        </div>
    </div>

    <div id="changePlanModal" class="modal">
        <div class="modal-content">
            <h2>Change Subscription Plan</h2>
            <p style="color: #666; margin-bottom: 20px;">Current Plan: <strong id="currentPlanDisplay"></strong></p>
            <div class="form-group">
                <label>Select New Plan</label>
                <select id="newPlan">
                    <option value="free">Free - Emergency Contact Only</option>
                    <option value="monthly">Monthly - $10/month</option>
                    <option value="annual">Annual - $100/year (Save $20!)</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="changePlan()">Change Plan</button>
            <button class="btn btn-secondary" onclick="closeModal('changePlanModal')">Cancel</button>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Forgot Password</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Enter your email to receive a password reset code</p>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="forgotEmail" placeholder="your@email.com">
            </div>
            <button class="btn btn-primary" onclick="requestPasswordReset()">Send Reset Code</button>
            <button class="btn btn-secondary" onclick="closeModal('forgotPasswordModal')">Cancel</button>
        </div>
    </div>

    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Reset Password</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Enter the 6-digit code sent to your email</p>
            <div class="form-group">
                <label>Reset Code</label>
                <input type="text" id="resetCode" placeholder="123456" maxlength="6">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="resetPassword" placeholder="Enter new password">
            </div>
            <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
        </div>
    </div>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // API Configuration - Auto-detect environment
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000/api'
            : `${window.location.protocol}//${window.location.host}/api`;
        
        // Global state
        let currentUser = null;
        let meetings = [];
        let alerts = [];
        let audioRecordings = [];
        
        let editingContactId = null;
        let activeMeetingId = null;
        let currentMeetingDetail = null;
        let pendingResetEmail = null;
        
        // Map variables
        let meetingMap = null;
        let meetingMapMarker = null;
        let locationWatchId = null;

        // Audio recording variables
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let currentTranscription = '';
        let isRecording = false;
        let recordingMeetingId = null;
        let usingServerTranscription = false;

        // SOS variables
        let sosActive = false;
        let sosStartTime = null;
        let sosInterval = null;
        let sosAudioInterval = null;
        let sosTimeoutId = null;
        let sosCaptureCount = 0;

        // Constants
        const GRACE_PERIOD_MS = 10 * 60 * 1000;
        const SOS_DURATION_MS = 15 * 60 * 1000;
        const SOS_AUDIO_INTERVAL_MS = 5 * 60 * 1000;

        // ============= API FUNCTIONS =============

        async function apiCall(endpoint, method = 'GET', data = null) {
            try {
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };

                if (data && method !== 'GET') {
                    options.body = JSON.stringify(data);
                }

                const response = await fetch(`${API_URL}${endpoint}`, options);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'API request failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        async function checkAPIStatus() {
            try {
                const response = await fetch(API_URL.replace('/api', '/'));
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    statusEl.textContent = response.ok ? '‚úÖ Connected' : '‚ùå Disconnected';
                    statusEl.style.color = response.ok ? '#10b981' : '#ef4444';
                }
            } catch (error) {
                const statusEl = document.getElementById('apiStatus');
                if (statusEl) {
                    statusEl.textContent = '‚ùå Server Offline';
                    statusEl.style.color = '#ef4444';
                }
            }
        }

        // ============= INITIALIZATION =============

        async function init() {
            // Check if user session exists
            const sessionUser = sessionStorage.getItem('currentUser');
            if (sessionUser) {
                currentUser = JSON.parse(sessionUser);
                await showDashboard();
                
                // Restore SOS state if exists
                const sosState = JSON.parse(sessionStorage.getItem('sosState'));
                if (sosState && sosState.active && sosState.userId === currentUser.id) {
                    const elapsed = Date.now() - sosState.startTime;
                    if (elapsed < SOS_DURATION_MS) {
                        sosActive = true;
                        sosStartTime = sosState.startTime;
                        sosCaptureCount = sosState.captureCount || 0;
                        updateSOSButton();
                        startSOSTimer();
                        updateSOSTab();
                    } else {
                        sessionStorage.removeItem('sosState');
                    }
                }
            }
            
            checkAPIStatus();
            setInterval(checkAPIStatus, 30000);
            
            // Check active meetings periodically
            setInterval(checkActiveMeetings, 30000);
        }

        async function checkActiveMeetings() {
            if (!currentUser) return;
            
            try {
                await loadMeetings();
                updateCurrentMeetingAlert();
            } catch (error) {
                console.error('Error checking active meetings:', error);
            }
        }

        function updateCurrentMeetingAlert() {
            // This function would check for active/overdue meetings and update the alert banner
            // Implementation would go here
        }

        // ============= AUTH FUNCTIONS =============

        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginTab').style.display = 'block';
                document.getElementById('registerTab').style.display = 'none';
                document.querySelectorAll('.tabs .tab')[0].classList.add('active');
                document.querySelectorAll('.tabs .tab')[1].classList.remove('active');
            } else {
                document.getElementById('loginTab').style.display = 'none';
                document.getElementById('registerTab').style.display = 'block';
                document.querySelectorAll('.tabs .tab')[0].classList.remove('active');
                document.querySelectorAll('.tabs .tab')[1].classList.add('active');
            }
        }

        async function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const plan = document.getElementById('regPlan').value;

            if (!name || !email || !phone || !password) {
                alert('Please fill in all fields');
                return;
            }

            try {
                const result = await apiCall('/register', 'POST', {
                    name, email, phone, password, plan
                });

                if (result.success) {
                    alert('Account created successfully! You can now login.');
                    switchAuthTab('login');
                    document.getElementById('loginEmail').value = email;
                }
            } catch (error) {
                alert('Registration failed: ' + error.message);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                alert('Please enter email and password');
                return;
            }

            try {
                const result = await apiCall('/login', 'POST', { email, password });

                if (result.success) {
                    currentUser = result.user;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    await showDashboard();
                }
            } catch (error) {
                alert('Login failed: ' + error.message);
            }
        }

        function logout() {
            stopLocationTracking();
            
            if (sosActive) {
                deactivateSOS();
            }
            
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            document.getElementById('authScreen').classList.add('active');
            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('meetingDetailScreen').classList.remove('active');
            document.getElementById('emergencyBtn').style.display = 'none';
        }

        function showForgotPassword() {
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        async function requestPasswordReset() {
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                alert('Please enter your email address');
                return;
            }

            try {
                const result = await apiCall('/forgot-password', 'POST', { email });

                if (result.success) {
                    pendingResetEmail = email;
                    closeModal('forgotPasswordModal');
                    alert(`Password reset code: ${result.token}\n\n(In production, this would be sent to your email)`);
                    document.getElementById('resetPasswordModal').classList.add('active');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function resetPassword() {
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('resetPassword').value;

            if (!code || !newPassword) {
                alert('Please enter the reset code and new password');
                return;
            }

            try {
                const result = await apiCall('/reset-password', 'POST', {
                    email: pendingResetEmail,
                    token: code,
                    new_password: newPassword
                });

                if (result.success) {
                    pendingResetEmail = null;
                    closeModal('resetPasswordModal');
                    alert('Password reset successfully! You can now login with your new password.');
                    switchAuthTab('login');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // ============= DASHBOARD FUNCTIONS =============

        async function showDashboard() {
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('dashboardScreen').classList.add('active');
            document.getElementById('meetingDetailScreen').classList.remove('active');
            document.getElementById('emergencyBtn').style.display = 'block';
            
            updateHeaderInfo();
            await loadMeetings();
            await loadContacts();
            await loadAlerts();
            checkAPIStatus();
        }

        function backToDashboard() {
            stopLocationTracking();
            showDashboard();
        }

        function updateHeaderInfo() {
            const badge = currentUser.plan === 'free' ? 'subscription-free' : 
                         currentUser.plan === 'monthly' ? 'subscription-monthly' : 'subscription-annual';
            const planText = currentUser.plan.charAt(0).toUpperCase() + currentUser.plan.slice(1);
            document.getElementById('userInfo').innerHTML = 
                `${currentUser.name} <span class="subscription-badge ${badge}">${planText}</span>`;
        }

        function switchDashTab(tab) {
            document.getElementById('meetingsTab').style.display = tab === 'meetings' ? 'block' : 'none';
            document.getElementById('monitoringTab').style.display = tab === 'monitoring' ? 'block' : 'none';
            document.getElementById('contactsTab').style.display = tab === 'contacts' ? 'block' : 'none';
            document.getElementById('alertsTab').style.display = tab === 'alerts' ? 'block' : 'none';
            document.getElementById('sosTab').style.display = tab === 'sos' ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = tab === 'settings' ? 'block' : 'none';

            const tabs = document.querySelectorAll('#dashboardScreen .tabs .tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'meetings') tabs[0].classList.add('active');
            if (tab === 'monitoring') tabs[1].classList.add('active');
            if (tab === 'contacts') tabs[2].classList.add('active');
            if (tab === 'alerts') tabs[3].classList.add('active');
            if (tab === 'sos') {
                tabs[4].classList.add('active');
                updateSOSTab();
                loadSOSRecordings();
            }
            if (tab === 'settings') tabs[5].classList.add('active');
        }

        function updateSOSTab() {
            const indicator = document.getElementById('sosIndicator');
            const activeBanner = document.getElementById('sosActiveBanner');
            const inactiveMessage = document.getElementById('sosInactiveMessage');
            const captureLog = document.getElementById('sosCaptureLog');
            
            if (sosActive) {
                indicator.style.display = 'inline-block';
                activeBanner.style.display = 'block';
                inactiveMessage.style.display = 'none';
                captureLog.style.display = 'block';
                
                const elapsed = Date.now() - sosStartTime;
                const remaining = SOS_DURATION_MS - elapsed;
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeDisplay = document.getElementById('sosTimeRemaining');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            } else {
                indicator.style.display = 'none';
                activeBanner.style.display = 'none';
                inactiveMessage.style.display = 'block';
                // Don't hide capture log - let loadSOSRecordings decide
            }
        }

        // ============= CONTACTS FUNCTIONS =============

        async function loadContacts() {
            try {
                const result = await apiCall(`/contacts?user_id=${currentUser.id}`);
                currentUser.contacts = result.contacts;
                displayContacts();
            } catch (error) {
                console.error('Failed to load contacts:', error);
                document.getElementById('contactsList').innerHTML = 
                    '<p style="color: #ef4444; text-align: center;">Failed to load contacts</p>';
            }
        }

        function displayContacts() {
            const container = document.getElementById('contactsList');

            if (!currentUser.contacts || currentUser.contacts.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">No emergency contacts added</p>';
                return;
            }

            container.innerHTML = currentUser.contacts.map(contact => `
                <div class="contact-card">
                    <h4>${contact.name}</h4>
                    <p>üìß ${contact.email}</p>
                    <p>üì± ${contact.phone}</p>
                    ${contact.relationship ? `<p>Relationship: ${contact.relationship}</p>` : ''}
                    <div class="contact-actions">
                        <button class="btn btn-primary btn-small" onclick="editContact(${contact.id})">‚úèÔ∏è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="removeContact(${contact.id})">üóëÔ∏è Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddContact() {
            if (currentUser.plan === 'free') {
                alert('Free accounts cannot add contacts. Please upgrade to add emergency contacts.');
                return;
            }
            
            editingContactId = null;
            document.getElementById('contactName').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactRelation').value = '';
            
            document.querySelector('#addContactModal h2').textContent = 'Add Emergency Contact';
            document.getElementById('addContactModal').classList.add('active');
        }

        async function addContact() {
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const phone = document.getElementById('contactPhone').value;
            const relationship = document.getElementById('contactRelation').value;

            if (!name || !email || !phone) {
                alert('Please fill in name, email, and phone');
                return;
            }

            try {
                if (editingContactId) {
                    await apiCall(`/contacts/${editingContactId}`, 'PUT', {
                        name, email, phone, relationship
                    });
                    alert('Contact updated successfully!');
                } else {
                    await apiCall('/contacts', 'POST', {
                        user_id: currentUser.id,
                        name, email, phone, relationship
                    });
                    alert('Contact added successfully!');
                }

                editingContactId = null;
                closeModal('addContactModal');
                await loadContacts();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function editContact(contactId) {
            const contact = currentUser.contacts.find(c => c.id === contactId);
            if (!contact) return;

            editingContactId = contactId;
            
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactEmail').value = contact.email;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactRelation').value = contact.relationship || '';
            
            document.querySelector('#addContactModal h2').textContent = 'Edit Emergency Contact';
            document.getElementById('addContactModal').classList.add('active');
        }

        async function removeContact(contactId) {
            if (!confirm('Are you sure you want to remove this contact?')) {
                return;
            }

            try {
                await apiCall(`/contacts/${contactId}`, 'DELETE');
                await loadContacts();
            } catch (error) {
                alert('Error removing contact: ' + error.message);
            }
        }

        // ============= MEETINGS FUNCTIONS =============

        async function loadMeetings() {
            try {
                const result = await apiCall(`/meetings?user_id=${currentUser.id}`);
                
                // Store meetings
                const organizedMeetings = result.organized || [];
                const asContactMeetings = result.as_contact || [];
                
                displayMeetings(organizedMeetings);
                displayMonitoringMeetings(asContactMeetings);
            } catch (error) {
                console.error('Failed to load meetings:', error);
                document.getElementById('upcomingMeetingsList').innerHTML = 
                    '<p style="color: #ef4444;">Failed to load meetings</p>';
            }
        }

        function displayMeetings(userMeetings) {
            const upcomingContainer = document.getElementById('upcomingMeetingsList');
            const pastContainer = document.getElementById('pastMeetingsList');
            
            const upcoming = userMeetings.filter(m => {
                const status = getMeetingStatus(m);
                return status !== 'ended' && status !== 'cancelled';
            });
            
            const past = userMeetings.filter(m => {
                const status = getMeetingStatus(m);
                return status === 'ended' || status === 'cancelled';
            }).sort((a, b) => new Date(b.start_time) - new Date(a.start_time))
              .slice(0, 10);

            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = '<p style="text-align:center; color:#999; padding:20px 0;">No upcoming meetings</p>';
            } else {
                upcomingContainer.innerHTML = upcoming.map(meeting => {
                    const startTime = new Date(meeting.start_time).toLocaleString();
                    const endTime = new Date(meeting.end_time).toLocaleString();
                    const status = getMeetingStatus(meeting);
                    
                    let statusBadge = 'status-upcoming';
                    let statusText = 'SCHEDULED';
                    
                    if (status === 'active') {
                        statusBadge = 'status-active';
                        statusText = 'ACTIVE';
                    } else if (status === 'grace') {
                        statusBadge = 'status-grace';
                        statusText = 'GRACE PERIOD';
                    } else if (status === 'overdue') {
                        statusBadge = 'status-overdue';
                        statusText = 'üö® OVERDUE';
                    }

                    return `
                        <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}">
                            <h4>Meeting with ${meeting.person_name}</h4>
                            <p>üìç ${meeting.location}</p>
                            <p>üïê ${startTime} - ${endTime}</p>
                            ${meeting.audio_capture_enabled ? '<p>üé§ Audio recording enabled</p>' : ''}
                            <p><span class="status-badge ${statusBadge}">${statusText}</span></p>
                            <div class="contact-actions">
                                ${status === 'active' || status === 'grace' || status === 'overdue' ? `
                                    <button class="btn btn-success btn-small" onclick="markSafe(${meeting.id})">‚úì I'm Safe</button>
                                    <button class="btn btn-danger btn-small" onclick="triggerMeetingEmergency(${meeting.id})">üö® Emergency!</button>
                                    <button class="btn btn-primary btn-small" onclick="viewMeetingDetail(${meeting.id})">üìã View Details</button>
                                ` : `
                                    <button class="btn btn-primary btn-small" onclick="viewMeetingDetail(${meeting.id})">üëÅÔ∏è View</button>
                                    <button class="btn btn-danger btn-small" onclick="cancelMeeting(${meeting.id})">‚úñ Cancel</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            if (past.length === 0) {
                pastContainer.innerHTML = '<p style="text-align:center; color:#999; padding:20px 0;">No past meetings</p>';
            } else {
                pastContainer.innerHTML = past.map(meeting => {
                    const startTime = new Date(meeting.start_time).toLocaleString();
                    
                    return `
                        <div class="meeting-card" style="opacity: 0.7;">
                            <h4>Meeting with ${meeting.person_name}</h4>
                            <p>üìç ${meeting.location}</p>
                            <p>üïê ${startTime}</p>
                            <p><span class="status-badge status-ended">${meeting.status.toUpperCase()}</span></p>
                            ${meeting.comments ? `<p style="color:#999; font-size:12px;">üìù ${meeting.comments}</p>` : ''}
                        </div>
                    `;
                }).join('');
            }
        }

        function displayMonitoringMeetings(meetings) {
            const container = document.getElementById('monitoringMeetingsList');
            const countBadge = document.getElementById('monitoringCount');
            
            const activeMonitoring = meetings.filter(m => {
                const status = getMeetingStatus(m);
                return status !== 'ended' && status !== 'cancelled';
            });

            if (activeMonitoring.length > 0) {
                countBadge.textContent = activeMonitoring.length;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }

            if (activeMonitoring.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">You are not monitoring any meetings</p>';
                return;
            }

            container.innerHTML = activeMonitoring.map(meeting => {
                const startTime = new Date(meeting.start_time).toLocaleString();
                const endTime = new Date(meeting.end_time).toLocaleString();
                const status = getMeetingStatus(meeting);
                
                let statusBadge = 'status-upcoming';
                let statusText = 'SCHEDULED';
                
                if (status === 'active') {
                    statusBadge = 'status-active';
                    statusText = 'ACTIVE NOW';
                } else if (status === 'grace') {
                    statusBadge = 'status-grace';
                    statusText = '‚ö†Ô∏è IN GRACE PERIOD';
                } else if (status === 'overdue') {
                    statusBadge = 'status-overdue';
                    statusText = 'üö® OVERDUE - MAY NEED HELP';
                }

                return `
                    <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}" style="border-left-color: ${status === 'overdue' ? '#ef4444' : status === 'grace' ? '#f59e0b' : '#0085CA'};">
                        <h4>${meeting.user_name}'s Meeting</h4>
                        <p><strong>Meeting with:</strong> ${meeting.person_name}</p>
                        <p>üìç ${meeting.location}</p>
                        <p>üïê ${startTime} - ${endTime}</p>
                        <p><span class="status-badge ${statusBadge}">${statusText}</span></p>
                        <div class="contact-actions">
                            <button class="btn btn-primary btn-small" onclick="viewMeetingDetail(${meeting.id})">üëÅÔ∏è View Details</button>
                            ${status === 'overdue' ? `
                                <button class="btn btn-danger btn-small" onclick="alert('Call ${meeting.user_phone}')">üìû Call ${meeting.user_name}</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getMeetingStatus(meeting) {
            const now = new Date();
            const start = new Date(meeting.start_time);
            const end = new Date(meeting.end_time);
            const graceEnd = new Date(end.getTime() + GRACE_PERIOD_MS);

            if (meeting.status === 'ended' || meeting.status === 'cancelled') {
                return meeting.status;
            }

            if (now < start) {
                return 'scheduled';
            } else if (now >= start && now <= end) {
                return 'active';
            } else if (now > end && now <= graceEnd) {
                return 'grace';
            } else if (now > graceEnd) {
                return 'overdue';
            }

            return meeting.status;
        }

        function showCreateMeeting() {
            if (currentUser.plan === 'free') {
                alert('Free accounts can only be emergency contacts. Please upgrade to create meetings.');
                return;
            }

            if (!currentUser.contacts || currentUser.contacts.length < 3) {
                alert('You need at least 3 emergency contacts to create a meeting.');
                return;
            }

            prepareCreateMeetingForm();
        }

        function prepareCreateMeetingForm() {
            document.getElementById('meetingPerson').value = '';
            document.getElementById('meetingLocation').value = '';
            document.getElementById('meetingStart').value = '';
            document.getElementById('meetingEnd').value = '';
            document.getElementById('meetingComments').value = '';
            document.getElementById('enableTracking').checked = false;
            document.getElementById('enableAudioCapture').checked = false;
            document.getElementById('enableSMS').checked = true;

            const container = document.getElementById('contactCheckboxes');
            container.innerHTML = '';
            currentUser.contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.innerHTML = `
                    <input type="checkbox" value="${contact.id}" id="contact_${contact.id}">
                    <label for="contact_${contact.id}">${contact.name} - ${contact.phone}</label>
                `;
                container.appendChild(div);
            });

            document.getElementById('createMeetingModal').classList.add('active');
        }

        async function createMeeting() {
            const person = document.getElementById('meetingPerson').value;
            const location = document.getElementById('meetingLocation').value;
            const start = document.getElementById('meetingStart').value;
            const end = document.getElementById('meetingEnd').value;
            const comments = document.getElementById('meetingComments').value;
            const tracking = document.getElementById('enableTracking').checked;
            const audioCapture = document.getElementById('enableAudioCapture').checked;
            const sendSMS = document.getElementById('enableSMS').checked;

            const selectedContactIds = [];
            currentUser.contacts.forEach(contact => {
                if (document.getElementById(`contact_${contact.id}`)?.checked) {
                    selectedContactIds.push(contact.id);
                }
            });

            if (!person || !location || !start || !end) {
                alert('Please fill in all required fields');
                return;
            }

            if (selectedContactIds.length < 3) {
                alert('Please select at least 3 emergency contacts');
                return;
            }

            try {
                const result = await apiCall('/meetings', 'POST', {
                    user_id: currentUser.id,
                    person_name: person,
                    location: location,
                    start_time: start,
                    end_time: end,
                    comments: comments || null,
                    tracking_enabled: tracking,
                    audio_capture: audioCapture,
                    sms_enabled: sendSMS,
                    contact_ids: selectedContactIds
                });

                if (result.success) {
                    closeModal('createMeetingModal');
                    await loadMeetings();
                    alert('Meeting created successfully!' + (sendSMS ? ' SMS notifications will be sent to emergency contacts.' : ''));
                }
            } catch (error) {
                alert('Error creating meeting: ' + error.message);
            }
        }

        async function viewMeetingDetail(meetingId) {
            try {
                const meeting = await apiCall(`/meetings/${meetingId}`);
                currentMeetingDetail = meeting;
                
                document.getElementById('dashboardScreen').classList.remove('active');
                document.getElementById('meetingDetailScreen').classList.add('active');

                const status = getMeetingStatus(meeting);
                const isActive = status === 'active' || status === 'grace' || status === 'overdue';
                const isOwner = meeting.user_id === currentUser.id;

                let statusBadge = 'status-upcoming';
                let statusText = 'SCHEDULED';
                
                if (status === 'active') {
                    statusBadge = 'status-active';
                    statusText = 'ACTIVE';
                } else if (status === 'grace') {
                    statusBadge = 'status-grace';
                    statusText = 'GRACE PERIOD';
                } else if (status === 'overdue') {
                    statusBadge = 'status-overdue';
                    statusText = 'üö® OVERDUE';
                } else if (status === 'ended') {
                    statusBadge = 'status-ended';
                    statusText = 'ENDED';
                }

                let detailHTML = `
                    <h2 style="color: #333; margin: 20px 0;">Meeting Details</h2>
                    <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}">
                        <h3>${meeting.person_name}</h3>
                        <p><strong>Location:</strong> ${meeting.location}</p>
                        <p><strong>Start:</strong> ${new Date(meeting.start_time).toLocaleString()}</p>
                        <p><strong>End:</strong> ${new Date(meeting.end_time).toLocaleString()}</p>
                        <p><strong>Status:</strong> <span class="status-badge ${statusBadge}">${statusText}</span></p>
                        <div style="background: #e0f2fe; border: 3px solid #0085CA; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center;">
                            <strong style="color: #0085CA; font-size: 14px; display: block; margin-bottom: 5px;">üîê Safety PIN</strong>
                            <span style="font-size: 32px; font-weight: bold; color: #0085CA; letter-spacing: 8px;">${meeting.pin}</span>
                            <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Emergency contacts need this PIN to clear alerts</p>
                        </div>
                        ${meeting.comments ? `<div class="comments-display"><strong>üìù Comments:</strong> ${meeting.comments}</div>` : ''}
                        <p><strong>Organizer:</strong> ${meeting.user_name} (${meeting.user_phone})</p>
                        <p><strong>Emergency Contacts:</strong></p>
                        <ul>
                            ${meeting.contacts.map(c => `<li>${c.name} - ${c.phone}</li>`).join('')}
                        </ul>
                        ${meeting.tracking_enabled ? '<p><strong>üìç Location Tracking:</strong> Enabled</p>' : ''}
                        ${meeting.audio_capture_enabled ? '<p><strong>üé§ Audio Recording:</strong> Enabled</p>' : ''}
                        ${meeting.sms_enabled ? '<p><strong>üì± SMS Notifications:</strong> Enabled</p>' : ''}
                    </div>
                `;

                // Audio capture box for active meetings with audio enabled
                if (meeting.audio_capture_enabled && isActive && isOwner) {
                    detailHTML += `
                        <div class="audio-capture-box" id="audioCaptureBox">
                            <div class="audio-capture-status">
                                <div class="recording-indicator" id="recordingIndicator" style="display:none;"></div>
                                <strong style="color: #92400e;">üé§ Emergency Audio Recording</strong>
                            </div>
                            <p style="color: #92400e; font-size: 13px; margin-bottom: 10px;">
                                When you press the emergency button, 60 seconds of audio will be automatically recorded and transcribed, then sent to your emergency contacts.
                            </p>
                            <div id="liveTranscription" class="transcription-display empty">
                                Transcription will appear here during recording...
                            </div>
                        </div>
                    `;
                }

                // Load and display existing audio recordings
                try {
                    const audioResult = await apiCall(`/audio-recordings/${meetingId}`);
                    if (audioResult.recordings && audioResult.recordings.length > 0) {
                        const baseURL = API_URL.replace('/api', '');
                        detailHTML += `
                            <div style="margin-top: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 10px;">
                                <h4 style="color: #92400e; margin-bottom: 10px;">üé§ Audio Recordings</h4>
                                ${audioResult.recordings.map(recording => {
                                    const time = new Date(recording.created_at).toLocaleString();
                                    const audioUrl = `${baseURL}${recording.url}`;
                                    return `
                                        <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                            <p style="font-size: 12px; color: #666; margin-bottom: 5px;">${time} - ${recording.alert_type.toUpperCase()}</p>
                                            <p style="font-size: 14px; color: #333; margin-bottom: 5px;"><strong>Transcription:</strong> "${recording.transcription}"</p>
                                            ${recording.latitude && recording.longitude ? `
                                                <p style="font-size: 12px; color: #666;">üìç ${recording.latitude.toFixed(6)}, ${recording.longitude.toFixed(6)}</p>
                                            ` : ''}
                                            <a href="${audioUrl}" download="${recording.filename}" class="audio-file-link">üìä Download Audio</a>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.log('No audio recordings found or error loading:', error);
                }

                if (status === 'overdue' && isOwner) {
                    detailHTML += `
                        <div style="margin-top: 20px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 10px;">
                            <strong style="color: #dc2626;">üö® URGENT: Meeting Overdue!</strong>
                            <p style="margin: 5px 0 0 0; color: #666;">You have exceeded your grace period. Please mark yourself safe immediately or trigger emergency alert if needed.</p>
                        </div>
                    `;
                }

                if (isActive && isOwner) {
                    detailHTML += `
                        <div style="margin-top: 20px;">
                            <button class="btn btn-success" onclick="markSafe(${meeting.id})">‚úì Mark Myself Safe</button>
                            <button class="btn btn-danger" onclick="triggerMeetingEmergency(${meeting.id})">üö® Emergency!</button>
                        </div>
                    `;
                }

                document.getElementById('meetingDetailContent').innerHTML = detailHTML;

            } catch (error) {
                alert('Error loading meeting: ' + error.message);
                backToDashboard();
            }
        }

        async function markSafe(meetingId) {
            try {
                // Mark meeting as ended
                await apiCall(`/meetings/${meetingId}`, 'PUT', { status: 'ended' });
                
                // Clear any alerts related to this meeting
                const relatedAlerts = alerts.filter(a => a.meeting_id === meetingId && !a.cleared);
                for (const alert of relatedAlerts) {
                    await apiCall(`/alerts/${alert.id}`, 'PUT', { cleared: true });
                }
                
                alert('‚úÖ Great! Meeting marked as ended safely. All alerts cleared.');
                await showDashboard();
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function cancelMeeting(meetingId) {
            if (!confirm('Are you sure you want to cancel this meeting?')) {
                return;
            }

            try {
                await apiCall(`/meetings/${meetingId}`, 'DELETE');
                await loadMeetings();
                alert('Meeting cancelled successfully.');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function triggerMeetingEmergency(meetingId) {
            if (!confirm('This will send emergency alerts to your selected contacts. Continue?')) {
                return;
            }

            try {
                // Get meeting details to check if audio is enabled
                const meeting = await apiCall(`/meetings/${meetingId}`);
                
                // Get current location
                let latitude = null;
                let longitude = null;
                
                if (navigator.geolocation) {
                    try {
                        const position = await new Promise((resolve, reject) => {
                            navigator.geolocation.getCurrentPosition(resolve, reject);
                        });
                        latitude = position.coords.latitude;
                        longitude = position.coords.longitude;
                    } catch (error) {
                        console.error('Geolocation error:', error);
                    }
                }

                // Create emergency alert in database
                await apiCall('/alerts', 'POST', {
                    user_id: currentUser.id,
                    meeting_id: meetingId,
                    alert_type: 'emergency',
                    latitude: latitude,
                    longitude: longitude
                });

                // Start audio recording if enabled
                if (meeting.audio_capture_enabled) {
                    console.log('Starting audio recording for emergency alert');
                    await startAudioRecording(meetingId, 'emergency');
                    alert('üö® Emergency alert sent to selected contacts! Audio recording started.');
                } else {
                    alert('üö® Emergency alert sent to selected contacts!');
                }
                
                await loadAlerts();
            } catch (error) {
                alert('Error sending alert: ' + error.message);
            }
        }

        // ============= ALERTS FUNCTIONS =============

        async function loadAlerts() {
            try {
                const result = await apiCall(`/alerts?user_id=${currentUser.id}`);
                alerts = result.alerts || [];
                displayAlerts();
            } catch (error) {
                console.error('Failed to load alerts:', error);
            }
        }

        function displayAlerts() {
            const container = document.getElementById('alertsList');
            const countBadge = document.getElementById('alertCount');
            const alertsTab = document.querySelectorAll('#dashboardScreen .tabs .tab')[3];
            
            const activeAlerts = alerts.filter(a => !a.cleared);

            if (activeAlerts.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">No active alerts</p>';
                countBadge.style.display = 'none';
                alertsTab.classList.remove('alert-active');
                return;
            }

            countBadge.textContent = activeAlerts.length;
            countBadge.style.display = 'inline-block';
            alertsTab.classList.add('alert-active');

            container.innerHTML = activeAlerts.map(alert => {
                const isMyAlert = alert.user_id === currentUser.id;
                
                return `
                    <div class="meeting-card alert-flash" style="border-left-color: #ff4757;">
                        <h4>‚ö†Ô∏è ${alert.alert_type.toUpperCase()} ALERT</h4>
                        <p><strong>${alert.user_name}</strong> may need help!</p>
                        ${alert.person_name ? `<p>Meeting with: ${alert.person_name}</p>` : ''}
                        ${alert.location ? `<p>Location: ${alert.location}</p>` : ''}
                        ${alert.latitude && alert.longitude ? `<p>üìç GPS: ${alert.latitude.toFixed(6)}, ${alert.longitude.toFixed(6)}</p>` : ''}
                        <p>Time: ${new Date(alert.created_at).toLocaleString()}</p>
                        <div class="contact-actions">
                            ${isMyAlert ? `
                                <button class="btn btn-success btn-small" onclick="clearMyAlert(${alert.id})">‚úì I'm Safe - Clear Alert</button>
                            ` : `
                                <button class="btn btn-danger btn-small" onclick="alert('Call ${alert.user_phone}')">üìû Call Now</button>
                                <button class="btn btn-secondary btn-small" onclick="clearContactAlert(${alert.id})">‚úì Clear Alert</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear alert when user marks themselves safe
        async function clearMyAlert(alertId) {
            try {
                await apiCall(`/alerts/${alertId}`, 'PUT', { cleared: true });
                
                // Update local alerts array
                const alertIndex = alerts.findIndex(a => a.id === alertId);
                if (alertIndex !== -1) {
                    alerts[alertIndex].cleared = true;
                }
                
                displayAlerts();
                alert('‚úÖ Alert cleared! Your contacts have been notified you are safe.');
            } catch (error) {
                console.error('Failed to clear alert:', error);
                alert('Error clearing alert. Please try again.');
            }
        }

        // Clear alert when emergency contact confirms
        async function clearContactAlert(alertId) {
            if (!confirm('Have you confirmed this person is safe?')) {
                return;
            }
            
            try {
                await apiCall(`/alerts/${alertId}`, 'PUT', { cleared: true });
                
                // Update local alerts array
                const alertIndex = alerts.findIndex(a => a.id === alertId);
                if (alertIndex !== -1) {
                    alerts[alertIndex].cleared = true;
                }
                
                displayAlerts();
                alert('‚úÖ Alert cleared.');
            } catch (error) {
                console.error('Failed to clear alert:', error);
                alert('Error clearing alert. Please try again.');
            }
        }

        // ============= ACCOUNT SETTINGS =============

        function showEditAccount() {
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editPassword').value = '';
            document.getElementById('editAccountModal').classList.add('active');
        }

        async function saveAccountChanges() {
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const password = document.getElementById('editPassword').value;

            if (!name || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            try {
                const updateData = { name, email, phone };
                if (password) {
                    updateData.password = password;
                }

                await apiCall(`/user/${currentUser.id}`, 'PUT', updateData);

                currentUser.name = name;
                currentUser.email = email;
                currentUser.phone = phone;
                sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

                closeModal('editAccountModal');
                updateHeaderInfo();
                alert('Account information updated successfully!');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        function showChangePlan() {
            const planText = currentUser.plan.charAt(0).toUpperCase() + currentUser.plan.slice(1);
            document.getElementById('currentPlanDisplay').textContent = planText;
            document.getElementById('newPlan').value = currentUser.plan;
            document.getElementById('changePlanModal').classList.add('active');
        }

        async function changePlan() {
            const newPlan = document.getElementById('newPlan').value;
            
            if (newPlan === currentUser.plan) {
                alert('This is already your current plan.');
                return;
            }

            if (confirm(`Change your plan to ${newPlan}?`)) {
                try {
                    await apiCall(`/user/${currentUser.id}`, 'PUT', { plan: newPlan });

                    currentUser.plan = newPlan;
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));

                    closeModal('changePlanModal');
                    updateHeaderInfo();
                    alert('Subscription plan updated successfully!');
                } catch (error) {
                    alert('Error: ' + error.message);
                }
            }
        }

        // ============= AUDIO RECORDING FUNCTIONS =============

        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported in this browser - will use server transcription');
                return null;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognitionInstance = new SpeechRecognition();
                recognitionInstance.continuous = true;
                recognitionInstance.interimResults = true;
                recognitionInstance.lang = 'en-US';
                
                recognitionInstance.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    currentTranscription += finalTranscript;
                    
                    const display = document.getElementById('liveTranscription');
                    if (display) {
                        display.textContent = currentTranscription + interimTranscript;
                        display.classList.remove('empty');
                    }
                };
                
                recognitionInstance.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                };
                
                recognitionInstance.onend = function() {
                    console.log('Speech recognition ended');
                };
                
                return recognitionInstance;
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                return null;
            }
        }

        async function startAudioRecording(meetingId, alertType = 'emergency') {
            try {
                if (isRecording) {
                    console.log('Already recording');
                    return;
                }
                
                console.log('Starting audio recording for', alertType, 'meetingId:', meetingId);
                isRecording = true;
                recordingMeetingId = meetingId;
                currentTranscription = '';
                audioChunks = [];
                usingServerTranscription = false;
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                console.log('Microphone access granted');
                
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    if (!recognition) {
                        recognition = initSpeechRecognition();
                    }
                    
                    if (recognition) {
                        try {
                            recognition.start();
                            console.log('Browser speech recognition started');
                        } catch (error) {
                            console.warn('Could not start speech recognition:', error);
                            usingServerTranscription = true;
                        }
                    }
                } else {
                    console.log('Browser speech recognition not available - will use server');
                    usingServerTranscription = true;
                }
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async function() {
                    console.log('Media recorder stopped');
                    
                    if (recognition) {
                        try {
                            recognition.stop();
                        } catch (error) {
                            console.warn('Error stopping speech recognition:', error);
                        }
                    }
                    
                    stream.getTracks().forEach(track => track.stop());
                    
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log('Audio blob created:', audioBlob.size, 'bytes');
                    
                    let latitude = null;
                    let longitude = null;
                    
                    if (navigator.geolocation) {
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, {
                                    timeout: 5000,
                                    maximumAge: 0
                                });
                            });
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                            console.log('Location obtained:', latitude, longitude);
                        } catch (error) {
                            console.error('Geolocation error:', error);
                        }
                    }
                    
                    await saveAudioRecording(audioBlob, currentTranscription, meetingId, alertType, latitude, longitude);
                    
                    isRecording = false;
                    recordingMeetingId = null;
                    
                    const captureBox = document.getElementById('audioCaptureBox');
                    if (captureBox) {
                        captureBox.classList.remove('recording');
                    }
                    
                    console.log('Recording complete');
                };
                
                mediaRecorder.onerror = function(event) {
                    console.error('MediaRecorder error:', event.error);
                };
                
                mediaRecorder.start();
                console.log('MediaRecorder started');
                
                const captureBox = document.getElementById('audioCaptureBox');
                if (captureBox) {
                    captureBox.classList.add('recording');
                }
                
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        console.log('60 seconds elapsed - stopping recording');
                        mediaRecorder.stop();
                    }
                }, 60000);
                
            } catch (error) {
                console.error('Error starting audio recording:', error);
                
                if (error.name === 'NotAllowedError') {
                    alert('Microphone access denied. Please allow microphone permissions in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    alert('No microphone found. Please connect a microphone and try again.');
                } else {
                    alert('Could not access microphone: ' + error.message);
                }
                
                isRecording = false;
            }
        }

        async function saveAudioRecording(audioBlob, transcription, meetingId, alertType, latitude, longitude) {
            const timestamp = Date.now();
            const userId = currentUser.id;
            
            console.log('Saving audio recording:', {
                meetingId,
                alertType,
                transcription: transcription.substring(0, 50) + '...',
                size: audioBlob.size
            });
            
            try {
                const formData = new FormData();
                formData.append('audio', audioBlob, `${meetingId}_${timestamp}_${userId}_${alertType}.webm`);
                formData.append('meetingId', meetingId);
                formData.append('userId', userId);
                formData.append('alertType', alertType);
                formData.append('transcription', transcription || 'No transcription available');
                formData.append('latitude', latitude || '');
                formData.append('longitude', longitude || '');
                
                // Use the base URL without /api for upload endpoint
                const baseURL = API_URL.replace('/api', '');
                const response = await fetch(`${baseURL}/api/upload-audio`, {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Audio upload failed: ' + response.status);
                }
                
                const result = await response.json();
                console.log('Audio uploaded to server:', result.url);
                
                alert('‚úÖ Audio recorded and uploaded successfully!');
                
            } catch (error) {
                console.error('Server upload failed:', error);
                alert('‚ö†Ô∏è Audio recorded but upload failed. Please check server connection.');
            }
        }

        // ============= SOS FUNCTIONS =============

        function toggleSOS() {
            if (sosActive) {
                if (confirm('Deactivate SOS alert and send "Safe" message to all contacts?')) {
                    deactivateSOS();
                }
            } else {
                if (confirm('This will send an SOS alert to ALL your emergency contacts and begin audio recording. Continue?')) {
                    activateSOS();
                }
            }
        }

        async function activateSOS() {
            if (!currentUser.contacts || currentUser.contacts.length === 0) {
                alert('You need to add emergency contacts first.');
                return;
            }
            
            sosActive = true;
            sosStartTime = Date.now();
            sosCaptureCount = 0;
            
            sessionStorage.setItem('sosState', JSON.stringify({
                active: true,
                userId: currentUser.id,
                startTime: sosStartTime,
                captureCount: sosCaptureCount
            }));
            
            updateSOSButton();
            updateSOSTab();
            
            await sendInitialSOSAlert();
            
            await captureSOSAudio();
            
            startSOSTimer();
            
            sosAudioInterval = setInterval(async () => {
                if (sosActive) {
                    await captureSOSAudio();
                }
            }, SOS_AUDIO_INTERVAL_MS);
        }

        function deactivateSOS() {
            sosActive = false;
            
            if (sosInterval) {
                clearInterval(sosInterval);
                sosInterval = null;
            }
            if (sosAudioInterval) {
                clearInterval(sosAudioInterval);
                sosAudioInterval = null;
            }
            if (sosTimeoutId) {
                clearTimeout(sosTimeoutId);
                sosTimeoutId = null;
            }
            
            sessionStorage.removeItem('sosState');
            
            updateSOSButton();
            updateSOSTab();
            
            sendSOSSafeMessage();
        }

        function startSOSTimer() {
            sosInterval = setInterval(() => {
                if (!sosActive) return;
                
                const elapsed = Date.now() - sosStartTime;
                const remaining = SOS_DURATION_MS - elapsed;
                
                if (remaining <= 0) {
                    sosActive = false;
                    clearInterval(sosInterval);
                    if (sosAudioInterval) clearInterval(sosAudioInterval);
                    sessionStorage.removeItem('sosState');
                    updateSOSButton();
                    updateSOSTab();
                    return;
                }
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeDisplay = document.getElementById('sosTimeRemaining');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            const remaining = SOS_DURATION_MS - (Date.now() - sosStartTime);
            sosTimeoutId = setTimeout(() => {
                if (sosActive) {
                    sosActive = false;
                    if (sosInterval) clearInterval(sosInterval);
                    if (sosAudioInterval) clearInterval(sosAudioInterval);
                    sessionStorage.removeItem('sosState');
                    updateSOSButton();
                    updateSOSTab();
                }
            }, remaining);
        }

        async function sendInitialSOSAlert() {
            let latitude = null;
            let longitude = null;
            
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                } catch (error) {
                    console.error('Geolocation error:', error);
                }
            }
            
            try {
                await apiCall('/alerts', 'POST', {
                    user_id: currentUser.id,
                    meeting_id: null,
                    alert_type: 'sos',
                    latitude: latitude,
                    longitude: longitude
                });
                
                console.log('SOS alert created in database');
            } catch (error) {
                console.error('Failed to create SOS alert:', error);
            }
        }

        async function captureSOSAudio() {
            sosCaptureCount++;
            
            sessionStorage.setItem('sosState', JSON.stringify({
                active: true,
                userId: currentUser.id,
                startTime: sosStartTime,
                captureCount: sosCaptureCount
            }));
            
            await startAudioRecording(0, 'sos');
        }

        function sendSOSSafeMessage() {
            console.log('SOS Safe message would be sent to all contacts');
            alert('‚úÖ SOS deactivated. Safe message sent to all contacts.');
        }

        function updateSOSButton() {
            const btn = document.getElementById('emergencyBtn');
            if (sosActive) {
                btn.classList.add('sos-active');
                btn.innerHTML = 'SOS<br>ACTIVE';
            } else {
                btn.classList.remove('sos-active');
                btn.innerHTML = 'SOS<br>HELP!';
            }
        }

        async function loadSOSRecordings() {
            try {
                // Get all audio recordings with alertType = 'sos' for current user
                const result = await apiCall(`/audio-recordings/0`);
                
                if (result.recordings && result.recordings.length > 0) {
                    const sosRecordings = result.recordings
                        .filter(r => r.alert_type === 'sos' && r.user_id === currentUser.id)
                        .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    if (sosRecordings.length > 0) {
                        displaySOSCaptureLog(sosRecordings);
                    }
                }
            } catch (error) {
                console.log('No SOS recordings found:', error);
            }
        }

        function displaySOSCaptureLog(sosRecordings) {
            const container = document.getElementById('sosCaptureEntries');
            const captureLog = document.getElementById('sosCaptureLog');
            
            if (sosRecordings.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No SOS alerts yet</p>';
                return;
            }
            
            captureLog.style.display = 'block';
            const baseURL = API_URL.replace('/api', '');
            
            container.innerHTML = sosRecordings.map(recording => {
                const time = new Date(recording.created_at).toLocaleString();
                const audioUrl = `${baseURL}${recording.url}`;
                let locationText = 'Location unavailable';
                let mapLink = '';
                
                if (recording.latitude && recording.longitude) {
                    locationText = `${recording.latitude.toFixed(6)}, ${recording.longitude.toFixed(6)}`;
                    mapLink = `<a href="https://www.google.com/maps?q=${recording.latitude},${recording.longitude}" target="_blank" style="color: #0085CA; font-size: 11px;">View on map</a>`;
                }
                
                return `
                    <div class="capture-entry">
                        <div class="user-name">üë§ ${recording.user_name || currentUser.name}</div>
                        <div class="timestamp">üé§ ${time}</div>
                        <div class="transcription">"${recording.transcription}"</div>
                        <div class="location">üìç ${locationText} ${mapLink}</div>
                        <a href="${audioUrl}" download="${recording.filename}" class="audio-file-link" style="margin-top: 8px;">üìä Download Audio</a>
                    </div>
                `;
            }).join('');
        }

        // ============= UTILITY FUNCTIONS =============

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
        }

        // Initialize on page load
        window.onload = init;
    </script>
</body>
</html>
