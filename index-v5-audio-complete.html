<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>SafeMeet v5.0 - Personal Safety App</title>
    
    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 5px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 20px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"],
        input[type="datetime-local"],
        input[type="tel"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #0085CA;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #0085CA 0%, #101820 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 133, 202, 0.4);
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-danger {
            background: #ff4757;
            color: white;
        }

        .btn-success {
            background: #2ed573;
            color: white;
        }

        .btn-small {
            width: auto;
            padding: 8px 15px;
            font-size: 14px;
            display: inline-block;
            margin-right: 5px;
        }

        .btn-link {
            background: none;
            color: #0085CA;
            text-decoration: underline;
            padding: 5px;
            font-size: 14px;
            cursor: pointer;
        }

        .tabs {
            display: flex;
            background: #f5f5f5;
            border-radius: 10px;
            padding: 5px;
            margin-bottom: 20px;
        }

        .tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 14px;
        }

        .tab.active {
            background: white;
            color: #0085CA;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab.alert-active {
            background: #ff4757 !important;
            color: white !important;
            animation: pulse-urgent 1.5s infinite;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.8);
        }

        .tab.alert-active.active {
            background: #ff4757 !important;
            color: white !important;
        }

        .contact-card, .meeting-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #0085CA;
        }

        .contact-card h4, .meeting-card h4 {
            color: #333;
            margin-bottom: 5px;
        }

        .contact-card p, .meeting-card p {
            color: #666;
            font-size: 14px;
            margin-bottom: 3px;
        }

        .emergency-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #ff4757;
            color: white;
            border: none;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 5px 25px rgba(255, 71, 87, 0.5);
            animation: pulse 2s infinite;
            z-index: 1000;
            transition: all 0.3s;
        }

        .emergency-button.sos-active {
            background: #2ed573;
            animation: pulse-sos 2s infinite;
            box-shadow: 0 5px 25px rgba(46, 213, 115, 0.8);
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 5px 25px rgba(255, 71, 87, 0.5);
            }
            50% {
                box-shadow: 0 5px 35px rgba(255, 71, 87, 0.8);
            }
        }

        @keyframes pulse-sos {
            0%, 100% {
                box-shadow: 0 5px 25px rgba(46, 213, 115, 0.5);
            }
            50% {
                box-shadow: 0 5px 35px rgba(46, 213, 115, 0.8);
            }
        }

        @keyframes flashAlert {
            0%, 100% {
                background-color: #fee2e2;
                border-color: #dc2626;
            }
            50% {
                background-color: #fef2f2;
                border-color: #ef4444;
            }
        }

        .alert-badge {
            background: #ff4757;
            color: white;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 8px;
            animation: flashAlert 0.8s infinite;
            box-shadow: 0 0 15px rgba(255, 71, 87, 0.8);
            border: 2px solid #fff;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 2000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            margin: 20px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        /* MAP STYLES */
        .map-container {
            width: 100%;
            height: 300px;
            border-radius: 10px;
            margin-top: 15px;
            overflow: hidden;
            border: 2px solid #0085CA;
        }

        .map-info {
            background: #e8f5e9;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .map-info strong {
            color: #0085CA;
        }

        .location-status {
            background: #dcfce7;
            border: 2px solid #10b981;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .subscription-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }

        .subscription-free {
            background: #e0e0e0;
            color: #666;
        }

        .subscription-monthly {
            background: #ffd93d;
            color: #333;
        }

        .subscription-annual {
            background: #6bcf7f;
            color: white;
        }

        .contact-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Dashboard Styles */
        .current-meeting-alert {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: none;
            align-items: center;
        }

        .current-meeting-alert.show {
            display: flex;
        }

        .current-meeting-alert.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .current-meeting-alert.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: flashAlert 1.5s infinite;
        }

        .current-meeting-alert .indicator {
            margin-right: 15px;
        }

        .current-meeting-alert .content {
            flex: 1;
        }

        .current-meeting-alert h3 {
            margin-bottom: 5px;
            font-size: 18px;
        }

        .current-meeting-alert p {
            margin: 0;
            opacity: 0.9;
            font-size: 14px;
        }

        .meeting-status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-green {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
        }

        .status-yellow {
            background: #f59e0b;
            box-shadow: 0 0 10px #f59e0b;
        }

        .status-red {
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            animation: pulse-urgent 1s infinite;
        }

        @keyframes pulse-urgent {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.8;
                transform: scale(1.1);
            }
        }

        .status-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-upcoming {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-ended {
            background: #f3f4f6;
            color: #6b7280;
        }

        .status-grace {
            background: #fef3c7;
            color: #92400e;
        }

        .status-overdue {
            background: #fee2e2;
            color: #991b1b;
            animation: flashAlert 1s infinite;
        }

        .alert-flash {
            animation: flashAlert 1s infinite;
            border: 3px solid #dc2626;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .settings-section h3 {
            color: #0085CA;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .settings-section h4 {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }

        .btn-warning {
            background: #ffa502;
            color: white;
        }

        .section-divider {
            border-top: 2px solid #e0e0e0;
            margin: 30px 0;
        }

        .comments-display {
            background: #f0f9ff;
            border-left: 4px solid #0085CA;
            padding: 12px 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
            color: #333;
        }

        .comments-display strong {
            color: #0085CA;
            display: block;
            margin-bottom: 5px;
        }

        .editable-comments-box {
            background: #fffbeb;
            border: 2px dashed #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .editable-comments-box label {
            color: #92400e;
            font-size: 14px;
        }

        /* AUDIO CAPTURE STYLES */
        .audio-capture-box {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
        }

        .audio-capture-box.recording {
            background: #fee2e2;
            border-color: #ef4444;
            animation: flashAlert 1.5s infinite;
        }

        .audio-capture-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .recording-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            margin-right: 10px;
            animation: pulse-urgent 1s infinite;
        }

        .transcription-display {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 12px;
            border-radius: 8px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            color: #333;
            margin-top: 10px;
        }

        .transcription-display.empty {
            color: #999;
            font-style: italic;
        }

        .audio-file-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 12px;
            background: #0085CA;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-size: 13px;
        }

        .audio-file-link:hover {
            background: #006da3;
        }

        /* SOS TAB STYLES */
        .sos-active-banner {
            background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .sos-active-banner h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .sos-active-banner p {
            margin: 0;
            opacity: 0.9;
        }

        .sos-capture-log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #2ed573;
        }

        .sos-capture-log h4 {
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .capture-entry {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e0e0e0;
        }

        .capture-entry .timestamp {
            font-weight: 600;
            color: #0085CA;
            font-size: 13px;
            margin-bottom: 5px;
        }

        .capture-entry .user-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .capture-entry .transcription {
            font-size: 14px;
            color: #333;
            margin: 5px 0;
        }

        .capture-entry .location {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .emergency-button {
                width: 60px;
                height: 60px;
                font-size: 11px;
                bottom: 20px;
                right: 20px;
            }

            .modal-content {
                padding: 20px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏èSafeMeetAlert</h1>
            <p>Your Personal Safety Companion v5.0</p>
            <div id="userInfo" style="margin-top: 10px; font-size: 12px;"></div>
        </div>

        <div class="content">
            <!-- Login/Register Screen -->
            <div id="authScreen" class="screen active">
                <div class="tabs">
                    <div class="tab active" onclick="switchAuthTab('login')">Login</div>
                    <div class="tab" onclick="switchAuthTab('register')">Register</div>
                </div>

                <div id="loginTab">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="loginEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="Enter password">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <button class="btn btn-link" onclick="showForgotPassword()">Forgot Password?</button>
                </div>

                <div id="registerTab" style="display:none;">
                    <div class="form-group">
                        <label>Full Name</label>
                        <input type="text" id="regName" placeholder="John Doe">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="regEmail" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="regPhone" placeholder="+1 (555) 123-4567">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="regPassword" placeholder="Create password">
                    </div>
                    <div class="form-group">
                        <label>Subscription Plan</label>
                        <select id="regPlan">
                            <option value="free">Free - Emergency Contact Only</option>
                            <option value="monthly">Monthly - $10/month</option>
                            <option value="annual">Annual - $100/year</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="register()">Create Account</button>
                </div>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="color: #333;">Dashboard</h2>
                    <button class="btn btn-small btn-secondary" onclick="logout()">Logout</button>
                </div>

                <!-- Current Meeting Status Alert -->
                <div id="currentMeetingAlert" class="current-meeting-alert">
                    <div class="indicator">
                        <div class="meeting-status-indicator" id="meetingStatusDot"></div>
                    </div>
                    <div class="content">
                        <h3 id="currentMeetingTitle"></h3>
                        <p id="currentMeetingDetails"></p>
                    </div>
                    <button class="btn btn-small" onclick="viewCurrentMeeting()" style="background: rgba(255,255,255,0.3); color: white; border: 2px solid white;">View</button>
                </div>

                <div class="tabs">
                    <div class="tab active" onclick="switchDashTab('meetings')">My Meetings</div>
                    <div class="tab" onclick="switchDashTab('monitoring')">Monitoring <span id="monitoringCount" style="display:none; background:#0085CA; color:white; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:5px;">0</span></div>
                    <div class="tab" onclick="switchDashTab('contacts')">Contacts</div>
                    <div class="tab" onclick="switchDashTab('alerts')">Alerts <span id="alertCount" class="alert-badge" style="display:none;">0</span></div>
                    <div class="tab" onclick="switchDashTab('sos')">SOS <span id="sosIndicator" style="display:none; background:#2ed573; color:white; padding:2px 6px; border-radius:10px; font-size:11px; margin-left:5px;">ACTIVE</span></div>
                    <div class="tab" onclick="switchDashTab('settings')">Settings</div>
                </div>

                <!-- Meetings Tab -->
                <div id="meetingsTab">
                    <button class="btn btn-primary" onclick="showCreateMeeting()">+ Create New Meeting</button>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Upcoming Meetings</h3>
                    <div id="upcomingMeetingsList"></div>
                    
                    <h3 style="margin-top: 30px; margin-bottom: 15px; color: #333;">Past Meetings</h3>
                    <div id="pastMeetingsList"></div>
                </div>

                <!-- Monitoring Tab -->
                <div id="monitoringTab" style="display:none;">
                    <div style="background: #e0f2fe; border-left: 4px solid #0085CA; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #0085CA; margin-bottom: 5px;">√∞≈∏‚Äò¬Å√Ø¬∏¬è Meetings You're Monitoring</h4>
                        <p style="color: #666; font-size: 13px; margin: 0;">You've been added as an emergency contact for these meetings</p>
                    </div>
                    <div id="monitoringMeetingsList"></div>
                </div>

                <!-- Contacts Tab -->
                <div id="contactsTab" style="display:none;">
                    <button class="btn btn-primary" onclick="showAddContact()">+ Add Emergency Contact</button>
                    <div id="contactsList"></div>
                </div>

                <!-- Alerts Tab -->
                <div id="alertsTab" style="display:none;">
                    <div id="alertsList"></div>
                </div>

                <!-- SOS Tab -->
                <div id="sosTab" style="display:none;">
                    <div id="sosActiveBanner" class="sos-active-banner" style="display:none;">
                        <h3>√∞≈∏‚Ä†Àú SOS ALERT ACTIVE</h3>
                        <p>Emergency alerts being sent to all contacts</p>
                        <p style="margin-top: 10px; font-size: 13px;">Audio capture occurs every 5 minutes</p>
                        <p style="margin-top: 5px; font-size: 13px;">Will auto-clear in <span id="sosTimeRemaining">15:00</span></p>
                        <button class="btn btn-danger btn-small" onclick="deactivateSOS()" style="margin-top: 15px;">Deactivate SOS</button>
                    </div>
                    
                    <div id="sosInactiveMessage" style="text-align: center; padding: 40px 20px; color: #666;">
                        <p>No active SOS alert</p>
                        <p style="font-size: 13px; margin-top: 10px;">Press the SOS button to activate emergency alerts</p>
                    </div>
                    
                    <div id="sosCaptureLog" style="display:none;">
                        <h3 style="color: #333; margin-bottom: 15px;">√∞≈∏‚Äú‚Äπ SOS Alert History</h3>
                        <div id="sosCaptureEntries"></div>
                    </div>
                </div>

                <div id="settingsTab" style="display:none;">
                    <div class="settings-section">
                        <h3>√¢≈°‚Ñ¢√Ø¬∏¬è Account Settings</h3>
                        <button class="btn btn-primary btn-small" onclick="showEditAccount()">√¢≈ì¬è√Ø¬∏¬è Edit Account Info</button>
                        <button class="btn btn-warning btn-small" onclick="showChangePlan()">√∞≈∏‚Äô¬≥ Change Subscription Plan</button>
                    </div>

                    <div class="settings-section">
                        <h3>√∞≈∏‚Äú¬• Import/Export Data</h3>
                        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">Backup and restore your contacts and meetings</p>
                        
                        <h4 style="color: #333; margin-bottom: 10px;">Contacts</h4>
                        <button class="btn btn-success btn-small" onclick="exportContacts()">√∞≈∏‚Äú¬§ Export Contacts</button>
                        <button class="btn btn-primary btn-small" onclick="document.getElementById('importContactsFile').click()">√∞≈∏‚Äú¬• Import Contacts</button>
                        <input type="file" id="importContactsFile" accept=".json" style="display:none;" onchange="importContacts(event)">
                        
                        <h4 style="color: #333; margin: 20px 0 10px;">Meetings</h4>
                        <button class="btn btn-success btn-small" onclick="exportMeetings()">√∞≈∏‚Äú¬§ Export Meetings</button>
                        <button class="btn btn-primary btn-small" onclick="document.getElementById('importMeetingsFile').click()">√∞≈∏‚Äú¬• Import Meetings</button>
                        <input type="file" id="importMeetingsFile" accept=".json" style="display:none;" onchange="importMeetings(event)">
                    </div>

                    <div class="settings-section">
                        <h3>√¢‚Äû¬π√Ø¬∏¬è About</h3>
                        <p style="color: #666; font-size: 14px;">SafeMeet v5.0 - Complete Edition with Audio Capture</p>
                        <p style="color: #666; font-size: 14px;">Your Personal Safety Companion</p>
                        <p style="color: #999; font-size: 12px; margin-top: 10px;">New: Hybrid audio transcription (browser + server)</p>
                    </div>
                </div>
            </div>

            <!-- Meeting Detail Screen -->
            <div id="meetingDetailScreen" class="screen">
                <button class="btn btn-secondary btn-small" onclick="backToDashboard()">√¢‚Ä†¬ê Back to Dashboard</button>
                <div id="meetingDetailContent"></div>
            </div>
        </div>
    </div>

    <!-- Emergency Button -->
    <button id="emergencyBtn" class="emergency-button" onclick="toggleSOS()" style="display:none;">
        SOS<br>HELP!
    </button>

    <!-- Modals -->
    <!-- Safety Tips Modal -->
    <div id="safetyTipsModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #ff4757; margin-bottom: 20px;">√¢≈°¬†√Ø¬∏¬è Important Safety Tips</h2>
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #856404; font-weight: 600; margin-bottom: 10px;">Before meeting someone you don't know well, please review these safety guidelines:</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="margin-bottom: 15px; display: flex; align-items: start;">
                    <span style="color: #ff4757; font-size: 24px; margin-right: 10px;">√∞≈∏¬è¬†</span>
                    <div>
                        <strong style="color: #333;">1. Never meet at your home</strong>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Protect your privacy and personal safety by avoiding home meetings.</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px; display: flex; align-items: start;">
                    <span style="color: #ff4757; font-size: 24px; margin-right: 10px;">√∞≈∏‚Äò¬•</span>
                    <div>
                        <strong style="color: #333;">2. If possible, take a 3rd party along</strong>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Bring a friend or family member for added security.</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px; display: flex; align-items: start;">
                    <span style="color: #ff4757; font-size: 24px; margin-right: 10px;">√∞≈∏≈°‚Äù</span>
                    <div>
                        <strong style="color: #333;">3. If you can, meet at police or fire stations</strong>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">These are the safest public locations for meeting strangers.</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 15px; display: flex; align-items: start;">
                    <span style="color: #ff4757; font-size: 24px; margin-right: 10px;">√∞≈∏‚Äô¬°</span>
                    <div>
                        <strong style="color: #333;">4. Be sure to meet in well-lit public locations with security cameras</strong>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Choose busy, well-monitored areas like shopping centers or restaurants.</p>
                    </div>
                </div>
                
                <div style="margin-bottom: 0; display: flex; align-items: start;">
                    <span style="color: #ff4757; font-size: 24px; margin-right: 10px;">√∞≈∏‚Äô¬µ</span>
                    <div>
                        <strong style="color: #333;">5. Never carry cash</strong>
                        <p style="color: #666; font-size: 14px; margin: 5px 0 0 0;">Use credit/debit cards or digital payment methods to avoid theft risk.</p>
                    </div>
                </div>
            </div>
            
            <div class="checkbox-group" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <input type="checkbox" id="acknowledgeSafety" style="width: auto; margin-right: 10px;">
                <label for="acknowledgeSafety" style="color: #1b5e20; font-weight: 600; margin: 0;">I have read and understand these safety tips</label>
            </div>
            
            <button class="btn btn-primary" onclick="acknowledgeSafetyTips()" id="proceedToMeetingBtn" disabled style="opacity: 0.5;">Continue to Create Meeting</button>
            <button class="btn btn-secondary" onclick="closeModal('safetyTipsModal')">Cancel</button>
        </div>
    </div>

    <!-- Audio Recording Legal Notice Modal -->
    <div id="audioLegalModal" class="modal">
        <div class="modal-content">
            <h2 style="color: #ff4757; margin-bottom: 20px;">√¢≈°¬†√Ø¬∏¬è Audio Recording Legal Notice</h2>
            
            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #856404; font-weight: 600;">By enabling audio recording, you acknowledge that:</p>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <ul style="list-style-position: inside; color: #333; font-size: 14px; line-height: 1.8;">
                    <li>Audio will be recorded during emergency situations</li>
                    <li>Recordings will be shared with your emergency contacts</li>
                    <li>You are responsible for complying with local recording laws</li>
                    <li>All parties may need to consent to recording in your jurisdiction</li>
                    <li>Audio files will be stored temporarily and may be deleted after a period</li>
                    <li>You agree to use this feature only for safety purposes</li>
                </ul>
            </div>
            
            <div style="background: #fee2e2; border-left: 4px solid #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <p style="color: #991b1b; font-size: 13px; font-weight: 600;">IMPORTANT: Check your local laws regarding audio recording. Some jurisdictions require all-party consent for audio recordings.</p>
            </div>
            
            <div class="checkbox-group" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <input type="checkbox" id="acknowledgeAudioLegal" style="width: auto; margin-right: 10px;">
                <label for="acknowledgeAudioLegal" style="color: #1b5e20; font-weight: 600; margin: 0;">I understand and agree to comply with all applicable laws regarding audio recording</label>
            </div>
            
            <button class="btn btn-primary" onclick="acceptAudioLegal()" id="acceptAudioBtn" disabled style="opacity: 0.5;">I Agree - Enable Audio Recording</button>
            <button class="btn btn-secondary" onclick="cancelAudioLegal()">Cancel</button>
        </div>
    </div>

    <div id="createMeetingModal" class="modal">
        <div class="modal-content">
            <h2>Create Meeting</h2>
            <div class="form-group">
                <label>Person Meeting</label>
                <input type="text" id="meetingPerson" placeholder="Name">
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="meetingLocation" placeholder="Address or place">
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="datetime-local" id="meetingStart">
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="datetime-local" id="meetingEnd">
            </div>
            <div class="form-group">
                <label>Comments (optional)</label>
                <textarea id="meetingComments" placeholder="Add any additional notes or special instructions..."></textarea>
            </div>
            <div class="form-group">
                <label>Photo (optional)</label>
                <input type="file" id="meetingPhoto" accept="image/*">
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableTracking">
                <label>Enable live location tracking</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableAudioCapture">
                <label>√∞≈∏≈Ω¬§ Enable emergency audio recording & transcription (60 seconds)</label>
            </div>
            <div class="checkbox-group">
                <input type="checkbox" id="enableSMS" checked>
                <label>Send SMS to emergency contacts</label>
            </div>
            <div class="form-group">
                <label>Select Emergency Contacts (min. 3)</label>
                <div id="contactCheckboxes"></div>
            </div>
            <button class="btn btn-primary" onclick="createMeeting()">Create Meeting</button>
            <button class="btn btn-secondary" onclick="closeModal('createMeetingModal')">Cancel</button>
        </div>
    </div>

    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <h2>Add Emergency Contact</h2>
            <div class="form-group">
                <label>Name</label>
                <input type="text" id="contactName" placeholder="Contact name">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="contactEmail" placeholder="contact@email.com">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="contactPhone" placeholder="+1 (555) 123-4567">
            </div>
            <div class="form-group">
                <label>Relationship</label>
                <input type="text" id="contactRelation" placeholder="Friend, Family, etc.">
            </div>
            <button class="btn btn-primary" onclick="addContact()">Add Contact</button>
            <button class="btn btn-secondary" onclick="closeModal('addContactModal')">Cancel</button>
        </div>
    </div>

    <div id="editAccountModal" class="modal">
        <div class="modal-content">
            <h2>Edit Account Information</h2>
            <div class="form-group">
                <label>Full Name</label>
                <input type="text" id="editName" placeholder="John Doe">
            </div>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>Phone</label>
                <input type="tel" id="editPhone" placeholder="+1 (555) 123-4567">
            </div>
            <div class="form-group">
                <label>Change Password (leave blank to keep current)</label>
                <input type="password" id="editPassword" placeholder="New password">
            </div>
            <button class="btn btn-primary" onclick="saveAccountChanges()">Save Changes</button>
            <button class="btn btn-secondary" onclick="closeModal('editAccountModal')">Cancel</button>
        </div>
    </div>

    <div id="changePlanModal" class="modal">
        <div class="modal-content">
            <h2>Change Subscription Plan</h2>
            <p style="color: #666; margin-bottom: 20px;">Current Plan: <strong id="currentPlanDisplay"></strong></p>
            <div class="form-group">
                <label>Select New Plan</label>
                <select id="newPlan">
                    <option value="free">Free - Emergency Contact Only</option>
                    <option value="monthly">Monthly - $10/month</option>
                    <option value="annual">Annual - $100/year (Save $20!)</option>
                </select>
            </div>
            <button class="btn btn-primary" onclick="changePlan()">Change Plan</button>
            <button class="btn btn-secondary" onclick="closeModal('changePlanModal')">Cancel</button>
        </div>
    </div>

    <div id="alertDetailModal" class="modal">
        <div class="modal-content">
            <h2>Alert Details</h2>
            <div id="alertDetailContent"></div>
            <button class="btn btn-secondary" onclick="closeModal('alertDetailModal')">Close</button>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Forgot Password</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Enter your email to receive a password reset code</p>
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="forgotEmail" placeholder="your@email.com">
            </div>
            <button class="btn btn-primary" onclick="requestPasswordReset()">Send Reset Code</button>
            <button class="btn btn-secondary" onclick="closeModal('forgotPasswordModal')">Cancel</button>
        </div>
    </div>

    <div id="resetPasswordModal" class="modal">
        <div class="modal-content">
            <h2>Reset Password</h2>
            <p style="color: #666; font-size: 14px; margin-bottom: 20px;">Enter the 6-digit code sent to your email</p>
            <div class="form-group">
                <label>Reset Code</label>
                <input type="text" id="resetCode" placeholder="123456" maxlength="6">
            </div>
            <div class="form-group">
                <label>New Password</label>
                <input type="password" id="resetPassword" placeholder="Enter new password">
            </div>
            <button class="btn btn-primary" onclick="resetPassword()">Reset Password</button>
            <button class="btn btn-secondary" onclick="closeModal('resetPasswordModal')">Cancel</button>
        </div>
    </div>

    <!-- Leaflet JS for maps -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Data storage - PERSIST ACROSS SESSIONS
        let users = JSON.parse(localStorage.getItem('users')) || [];
        let currentUser = JSON.parse(localStorage.getItem('currentUser')) || null;
        let meetings = JSON.parse(localStorage.getItem('meetings')) || [];
        let alerts = JSON.parse(localStorage.getItem('globalAlerts')) || []; // Changed key to globalAlerts
        let audioRecordings = JSON.parse(localStorage.getItem('audioRecordings')) || [];

        let editingContactId = null;
        let activeMeetingId = null;
        let currentMeetingDetail = null;
        let pendingResetEmail = null;
        
        // Map variables
        let meetingMap = null;
        let meetingMapMarker = null;
        let locationWatchId = null;

        // Audio recording variables
        let mediaRecorder = null;
        let audioChunks = [];
        let recognition = null;
        let currentTranscription = '';
        let isRecording = false;
        let recordingMeetingId = null;
        let usingServerTranscription = false;

        // SOS variables
        let sosActive = false;
        let sosStartTime = null;
        let sosInterval = null;
        let sosAudioInterval = null;
        let sosTimeoutId = null;
        let sosCaptureCount = 0;

        // Grace period constant (10 minutes in milliseconds)
        const GRACE_PERIOD_MS = 10 * 60 * 1000;
        const SOS_DURATION_MS = 15 * 60 * 1000; // 15 minutes
        const SOS_AUDIO_INTERVAL_MS = 5 * 60 * 1000; // 5 minutes

        // Get SafeMeet URL
        function getSafeMeetURL() {
            return window.location.origin + window.location.pathname;
        }

        // Save alerts globally (persist across logout)
        function saveAlertsGlobally() {
            localStorage.setItem('globalAlerts', JSON.stringify(alerts));
        }

        // Initialize app
        function init() {
            if (currentUser) {
                showDashboard();
                // Check if SOS was active and restore state
                const sosState = JSON.parse(localStorage.getItem('sosState'));
                if (sosState && sosState.active && sosState.userId === currentUser.id) {
                    const elapsed = Date.now() - sosState.startTime;
                    if (elapsed < SOS_DURATION_MS) {
                        sosActive = true;
                        sosStartTime = sosState.startTime;
                        sosCaptureCount = sosState.captureCount || 0;
                        updateSOSButton();
                        startSOSTimer();
                        updateSOSTab();
                    } else {
                        // SOS expired, clear it
                        localStorage.removeItem('sosState');
                    }
                }
            }
            checkActiveMeetings();
            setInterval(checkActiveMeetings, 30000); // Check every 30 seconds
            
            // Initialize audio capture checkbox listener
            initAudioCaptureListener();
        }

        // Initialize audio capture checkbox listener
        function initAudioCaptureListener() {
            const checkbox = document.getElementById('enableAudioCapture');
            if (checkbox) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        showAudioLegalNotice();
                    }
                });
            }
        }

        // Show audio legal notice
        function showAudioLegalNotice() {
            document.getElementById('acknowledgeAudioLegal').checked = false;
            document.getElementById('acceptAudioBtn').disabled = true;
            document.getElementById('acceptAudioBtn').style.opacity = '0.5';
            document.getElementById('audioLegalModal').classList.add('active');
        }

        // Accept audio legal notice
        function acceptAudioLegal() {
            const acknowledged = document.getElementById('acknowledgeAudioLegal').checked;
            if (!acknowledged) {
                alert('Please acknowledge that you understand the legal requirements.');
                return;
            }
            closeModal('audioLegalModal');
        }

        // Cancel audio legal notice
        function cancelAudioLegal() {
            document.getElementById('enableAudioCapture').checked = false;
            closeModal('audioLegalModal');
        }

        // Enable accept button when checkbox is checked
        document.addEventListener('DOMContentLoaded', function() {
            const audioLegalCheckbox = document.getElementById('acknowledgeAudioLegal');
            if (audioLegalCheckbox) {
                audioLegalCheckbox.addEventListener('change', function() {
                    const acceptBtn = document.getElementById('acceptAudioBtn');
                    if (this.checked) {
                        acceptBtn.disabled = false;
                        acceptBtn.style.opacity = '1';
                    } else {
                        acceptBtn.disabled = true;
                        acceptBtn.style.opacity = '0.5';
                    }
                });
            }
        });

        // Initialize Web Speech API
        function initSpeechRecognition() {
            // Check if browser supports speech recognition
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported in this browser - will use server transcription');
                return null;
            }
            
            try {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognitionInstance = new SpeechRecognition();
                recognitionInstance.continuous = true;
                recognitionInstance.interimResults = true;
                recognitionInstance.lang = 'en-US';
                
                recognitionInstance.onresult = function(event) {
                    let interimTranscript = '';
                    let finalTranscript = '';
                    
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    currentTranscription += finalTranscript;
                    
                    // Update transcription display
                    const display = document.getElementById('liveTranscription');
                    if (display) {
                        display.textContent = currentTranscription + interimTranscript;
                        display.classList.remove('empty');
                    }
                };
                
                recognitionInstance.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    if (event.error === 'no-speech') {
                        console.log('No speech detected - this is normal if user is not speaking');
                    } else if (event.error === 'not-allowed') {
                        console.warn('Microphone access denied for speech recognition');
                    }
                };
                
                recognitionInstance.onend = function() {
                    console.log('Speech recognition ended');
                };
                
                return recognitionInstance;
            } catch (error) {
                console.error('Error initializing speech recognition:', error);
                return null;
            }
        }

        // Transcribe audio on server (fallback for non-Chrome browsers)
        async function transcribeOnServer(audioBlob) {
            try {
                console.log('Sending audio to server for transcription...');
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.webm');
                
                const response = await fetch('/api/transcribe', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error('Server transcription failed: ' + response.status);
                }
                
                const result = await response.json();
                console.log('Server transcription received:', result.transcription);
                return result.transcription;
            } catch (error) {
                console.error('Server transcription error:', error);
                return 'Transcription unavailable (server error)';
            }
        }

        // Start audio recording with hybrid transcription
        async function startAudioRecording(meetingId, alertType = 'emergency') {
            try {
                if (isRecording) {
                    console.log('Already recording');
                    return;
                }
                
                console.log('Starting audio recording for', alertType, 'meetingId:', meetingId);
                isRecording = true;
                recordingMeetingId = meetingId;
                currentTranscription = '';
                audioChunks = [];
                usingServerTranscription = false;
                
                // Request microphone access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                console.log('Microphone access granted');
                
                // Try browser speech recognition (Chrome/Edge only)
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    if (!recognition) {
                        recognition = initSpeechRecognition();
                    }
                    
                    if (recognition) {
                        try {
                            recognition.start();
                            console.log('Browser speech recognition started');
                        } catch (error) {
                            console.warn('Could not start speech recognition:', error);
                            usingServerTranscription = true;
                        }
                    }
                } else {
                    console.log('Browser speech recognition not available - will use server');
                    usingServerTranscription = true;
                }
                
                // Always record audio
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                mediaRecorder.ondataavailable = function(event) {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async function() {
                    console.log('Media recorder stopped');
                    
                    // Stop speech recognition
                    if (recognition) {
                        try {
                            recognition.stop();
                        } catch (error) {
                            console.warn('Error stopping speech recognition:', error);
                        }
                    }
                    
                    // Stop all tracks
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Create audio blob
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    console.log('Audio blob created:', audioBlob.size, 'bytes');
                    
                    // If no browser transcription or using server, get server transcription
                    if (!currentTranscription || currentTranscription.trim() === '' || usingServerTranscription) {
                        console.log('Getting server transcription...');
                        currentTranscription = await transcribeOnServer(audioBlob);
                    }
                    
                    // Get current location
                    let latitude = null;
                    let longitude = null;
                    
                    if (navigator.geolocation) {
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, {
                                    timeout: 5000,
                                    maximumAge: 0
                                });
                            });
                            latitude = position.coords.latitude;
                            longitude = position.coords.longitude;
                            console.log('Location obtained:', latitude, longitude);
                        } catch (error) {
                            console.error('Geolocation error:', error);
                        }
                    }
                    
                    // Save audio recording
                    await saveAudioRecording(audioBlob, currentTranscription, meetingId, alertType, latitude, longitude);
                    
                    isRecording = false;
                    recordingMeetingId = null;
                    
                    // Update UI
                    const captureBox = document.getElementById('audioCaptureBox');
                    if (captureBox) {
                        captureBox.classList.remove('recording');
                    }
                    
                    console.log('Recording complete');
                };
                
                mediaRecorder.onerror = function(event) {
                    console.error('MediaRecorder error:', event.error);
                };
                
                mediaRecorder.start();
                console.log('MediaRecorder started');
                
                // Update UI
                const captureBox = document.getElementById('audioCaptureBox');
                if (captureBox) {
                    captureBox.classList.add('recording');
                }
                
                // Stop recording after 60 seconds
                setTimeout(() => {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        console.log('60 seconds elapsed - stopping recording');
                        mediaRecorder.stop();
                    }
                }, 60000);
                
            } catch (error) {
                console.error('Error starting audio recording:', error);
                
                if (error.name === 'NotAllowedError') {
                    alert('Microphone access denied. Please allow microphone permissions in your browser settings.');
                } else if (error.name === 'NotFoundError') {
                    alert('No microphone found. Please connect a microphone and try again.');
                } else {
                    alert('Could not access microphone: ' + error.message);
                }
                
                isRecording = false;
            }
        }

        // Save audio recording
        async function saveAudioRecording(audioBlob, transcription, meetingId, alertType, latitude, longitude) {
            const timestamp = Date.now();
            const userId = currentUser.id;
            const filename = `${meetingId}_${timestamp}_${userId}_${alertType}.webm`;
            
            console.log('Saving audio recording:', {
                meetingId,
                alertType,
                transcription: transcription.substring(0, 50) + '...',
                size: audioBlob.size
            });
            
            // Convert blob to base64 for localStorage
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            
            reader.onloadend = async function() {
                const base64Audio = reader.result;
                
                const recording = {
                    id: timestamp,
                    meetingId: meetingId,
                    userId: userId,
                    userName: currentUser.name,
                    alertType: alertType,
                    filename: filename,
                    transcription: transcription || 'No transcription available',
                    latitude: latitude,
                    longitude: longitude,
                    timestamp: new Date().toISOString(),
                    audioData: base64Audio
                };
                
                // Save to localStorage
                audioRecordings.push(recording);
                localStorage.setItem('audioRecordings', JSON.stringify(audioRecordings));
                console.log('Audio saved to localStorage');
                
                // Try to upload to server
                try {
                    const formData = new FormData();
                    formData.append('audio', audioBlob, filename);
                    formData.append('meetingId', meetingId);
                    formData.append('userId', userId);
                    formData.append('alertType', alertType);
                    formData.append('transcription', transcription || '');
                    formData.append('latitude', latitude || '');
                    formData.append('longitude', longitude || '');
                    
                    const response = await fetch('/api/upload-audio', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        recording.serverUrl = result.url;
                        console.log('Audio uploaded to server:', result.url);
                        
                        // Update localStorage with server URL
                        const index = audioRecordings.findIndex(r => r.id === recording.id);
                        if (index !== -1) {
                            audioRecordings[index] = recording;
                            localStorage.setItem('audioRecordings', JSON.stringify(audioRecordings));
                        }
                    }
                } catch (error) {
                    console.log('Server upload failed, using localStorage only:', error);
                }
                
                // Send updated SMS with audio
                await sendAudioAlertSMS(recording, meetingId, alertType);
                
                // Update SOS log if this is an SOS recording
                if (alertType === 'sos') {
                    updateSOSCaptureLog(recording);
                }
            };
        }

        // Send SMS with audio transcription and link
        async function sendAudioAlertSMS(recording, meetingId, alertType) {
            const meeting = meetings.find(m => m.id === meetingId);
            let contacts = [];
            
            if (alertType === 'sos') {
                // SOS sends to ALL contacts
                contacts = currentUser.contacts;
            } else if (meeting) {
                // Emergency meeting alert sends to meeting contacts
                contacts = meeting.contacts;
            }
            
            if (contacts.length === 0) return;
            
            const safeMeetURL = getSafeMeetURL();
            let locationInfo = '';
            let googleMapsLink = '';
            
            if (recording.latitude && recording.longitude) {
                locationInfo = ` GPS: ${recording.latitude.toFixed(6)}, ${recording.longitude.toFixed(6)}`;
                googleMapsLink = ` Map: https://www.google.com/maps?q=${recording.latitude},${recording.longitude}`;
            }
            
            const audioLink = recording.serverUrl || `${safeMeetURL}#audio/${recording.id}`;
            
            let message = '';
            if (alertType === 'sos') {
                message = `√∞≈∏‚Ä†Àú SOS UPDATE: ${currentUser.name} emergency alert with audio recording!\n` +
                         `√∞≈∏‚Äú¬± Call: ${currentUser.phone}\n` +
                         `${locationInfo}${googleMapsLink}\n` +
                         `√∞≈∏≈Ω¬§ Audio Transcription: "${recording.transcription}"\n` +
                         `√∞≈∏‚Äù≈† Listen: ${audioLink}\n` +
                         `SafeMeet: ${safeMeetURL}`;
            } else {
                const meetingInfo = meeting ? ` Meeting with ${meeting.person} at ${meeting.location}.` : '';
                const pinInfo = meeting ? ` PIN: ${meeting.pin}` : '';
                message = `√∞≈∏≈°¬® EMERGENCY UPDATE: ${currentUser.name} needs help!${meetingInfo}\n` +
                         `${locationInfo}${googleMapsLink}\n` +
                         `√∞≈∏≈Ω¬§ Audio Transcription: "${recording.transcription}"\n` +
                         `√∞≈∏‚Äù≈† Listen: ${audioLink}\n` +
                         `√∞≈∏‚Äú¬± Call: ${currentUser.phone}${pinInfo}\n` +
                         `SafeMeet: ${safeMeetURL}`;
            }
            
            contacts.forEach(contact => {
                console.log(`SMS to ${contact.phone}: ${message}`);
                simulateSMS(contact.phone, message);
            });
        }

        // Toggle SOS Alert
        function toggleSOS() {
            if (sosActive) {
                // Deactivate SOS
                if (confirm('Deactivate SOS alert and send "Safe" message to all contacts?')) {
                    deactivateSOS();
                }
            } else {
                // Activate SOS
                if (confirm('This will send an SOS alert to ALL your emergency contacts and begin audio recording. Continue?')) {
                    activateSOS();
                }
            }
        }

        // Activate SOS
        async function activateSOS() {
            if (currentUser.contacts.length === 0) {
                alert('You need to add emergency contacts first.');
                return;
            }
            
            sosActive = true;
            sosStartTime = Date.now();
            sosCaptureCount = 0;
            
            // Save SOS state
            localStorage.setItem('sosState', JSON.stringify({
                active: true,
                userId: currentUser.id,
                startTime: sosStartTime,
                captureCount: sosCaptureCount
            }));
            
            updateSOSButton();
            updateSOSTab();
            
            // Send initial SOS alert
            await sendInitialSOSAlert();
            
            // Start first audio capture immediately
            await captureSOSAudio();
            
            // Start timer for countdown and auto-deactivation
            startSOSTimer();
            
            // Schedule audio captures every 5 minutes
            sosAudioInterval = setInterval(async () => {
                if (sosActive) {
                    await captureSOSAudio();
                }
            }, SOS_AUDIO_INTERVAL_MS);
        }

        // Deactivate SOS
        function deactivateSOS() {
            sosActive = false;
            
            // Clear intervals and timeout
            if (sosInterval) {
                clearInterval(sosInterval);
                sosInterval = null;
            }
            if (sosAudioInterval) {
                clearInterval(sosAudioInterval);
                sosAudioInterval = null;
            }
            if (sosTimeoutId) {
                clearTimeout(sosTimeoutId);
                sosTimeoutId = null;
            }
            
            // Clear SOS state
            localStorage.removeItem('sosState');
            
            updateSOSButton();
            updateSOSTab();
            
            // Send safe message
            sendSOSSafeMessage();
        }

        // Start SOS timer
        function startSOSTimer() {
            // Update countdown every second
            sosInterval = setInterval(() => {
                if (!sosActive) return;
                
                const elapsed = Date.now() - sosStartTime;
                const remaining = SOS_DURATION_MS - elapsed;
                
                if (remaining <= 0) {
                    // Auto-deactivate (no safe message)
                    sosActive = false;
                    clearInterval(sosInterval);
                    if (sosAudioInterval) clearInterval(sosAudioInterval);
                    localStorage.removeItem('sosState');
                    updateSOSButton();
                    updateSOSTab();
                    return;
                }
                
                // Update countdown display
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeDisplay = document.getElementById('sosTimeRemaining');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
            
            // Set timeout for auto-deactivation
            const remaining = SOS_DURATION_MS - (Date.now() - sosStartTime);
            sosTimeoutId = setTimeout(() => {
                if (sosActive) {
                    sosActive = false;
                    if (sosInterval) clearInterval(sosInterval);
                    if (sosAudioInterval) clearInterval(sosAudioInterval);
                    localStorage.removeItem('sosState');
                    updateSOSButton();
                    updateSOSTab();
                }
            }, remaining);
        }

        // Send initial SOS alert
        async function sendInitialSOSAlert() {
            let latitude = null;
            let longitude = null;
            
            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject);
                    });
                    latitude = position.coords.latitude;
                    longitude = position.coords.longitude;
                } catch (error) {
                    console.error('Geolocation error:', error);
                }
            }
            
            const safeMeetURL = getSafeMeetURL();
            let locationInfo = '';
            let googleMapsLink = '';
            
            if (latitude && longitude) {
                locationInfo = ` GPS: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                googleMapsLink = ` Track: https://www.google.com/maps?q=${latitude},${longitude}`;
            }
            
            const message = `√∞≈∏‚Ä†Àú SOS ALERT: ${currentUser.name} has activated emergency SOS!\n` +
                          `√∞≈∏‚Äú¬± Call immediately: ${currentUser.phone}\n` +
                          `${locationInfo}${googleMapsLink}\n` +
                          `Audio recording in progress...\n` +
                          `SafeMeet: ${safeMeetURL}`;
            
            currentUser.contacts.forEach(contact => {
                console.log(`SOS SMS to ${contact.phone}: ${message}`);
                simulateSMS(contact.phone, message);
            });
        }

        // Capture SOS audio
        async function captureSOSAudio() {
            sosCaptureCount++;
            
            // Update SOS state
            localStorage.setItem('sosState', JSON.stringify({
                active: true,
                userId: currentUser.id,
                startTime: sosStartTime,
                captureCount: sosCaptureCount
            }));
            
            // Start audio recording (meetingId = 0 for SOS)
            await startAudioRecording(0, 'sos');
        }

        // Send SOS safe message
        function sendSOSSafeMessage() {
            const safeMeetURL = getSafeMeetURL();
            const message = `√¢≈ì‚Ä¶ SOS CLEARED: ${currentUser.name} has deactivated their SOS alert and indicates they are now safe.\n` +
                          `SafeMeet: ${safeMeetURL}`;
            
            currentUser.contacts.forEach(contact => {
                console.log(`SOS Safe SMS to ${contact.phone}: ${message}`);
                simulateSMS(contact.phone, message);
            });
        }

        // Update SOS button appearance
        function updateSOSButton() {
            const btn = document.getElementById('emergencyBtn');
            if (sosActive) {
                btn.classList.add('sos-active');
                btn.innerHTML = 'SOS<br>ACTIVE';
            } else {
                btn.classList.remove('sos-active');
                btn.innerHTML = 'SOS<br>HELP!';
            }
        }

        // Update SOS tab
        function updateSOSTab() {
            const indicator = document.getElementById('sosIndicator');
            const activeBanner = document.getElementById('sosActiveBanner');
            const inactiveMessage = document.getElementById('sosInactiveMessage');
            const captureLog = document.getElementById('sosCaptureLog');
            
            if (sosActive) {
                indicator.style.display = 'inline-block';
                activeBanner.style.display = 'block';
                inactiveMessage.style.display = 'none';
                captureLog.style.display = 'block';
                
                // Update countdown
                const elapsed = Date.now() - sosStartTime;
                const remaining = SOS_DURATION_MS - elapsed;
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeDisplay = document.getElementById('sosTimeRemaining');
                if (timeDisplay) {
                    timeDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }
                
                // Display SOS captures
                displaySOSCaptureLog();
            } else {
                indicator.style.display = 'none';
                activeBanner.style.display = 'none';
                inactiveMessage.style.display = 'block';
                
                // Show capture log if there are any SOS recordings
                const sosRecordings = audioRecordings.filter(r => r.alertType === 'sos');
                if (sosRecordings.length > 0) {
                    captureLog.style.display = 'block';
                    displaySOSCaptureLog();
                } else {
                    captureLog.style.display = 'none';
                }
            }
        }

        // Update SOS capture log
        function updateSOSCaptureLog(recording) {
            displaySOSCaptureLog();
        }

        // Display SOS capture log (FIX #2 - Reverse chronological with user names)
        function displaySOSCaptureLog() {
            const container = document.getElementById('sosCaptureEntries');
            const sosRecordings = audioRecordings.filter(r => r.alertType === 'sos')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // REVERSE CHRONOLOGICAL
            
            if (sosRecordings.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:20px;">No SOS alerts yet</p>';
                return;
            }
            
            container.innerHTML = sosRecordings.map(recording => {
                const time = new Date(recording.timestamp).toLocaleString();
                const audioUrl = recording.serverUrl || recording.audioData;
                let locationText = 'Location unavailable';
                let mapLink = '';
                
                if (recording.latitude && recording.longitude) {
                    locationText = `${recording.latitude.toFixed(6)}, ${recording.longitude.toFixed(6)}`;
                    mapLink = `<a href="https://www.google.com/maps?q=${recording.latitude},${recording.longitude}" target="_blank" style="color: #0085CA; font-size: 11px;">View on map</a>`;
                }
                
                return `
                    <div class="capture-entry">
                        <div class="user-name">√∞≈∏‚Äò¬§ ${recording.userName}</div>
                        <div class="timestamp">√∞≈∏≈Ω¬§ ${time}</div>
                        <div class="transcription">"${recording.transcription}"</div>
                        <div class="location">√∞≈∏‚Äú¬ç ${locationText} ${mapLink}</div>
                        ${audioUrl ? `<a href="${audioUrl}" download="${recording.filename}" class="audio-file-link" style="margin-top: 8px;">√∞≈∏‚Äù≈† Download Audio</a>` : ''}
                    </div>
                `;
            }).join('');
        }

        // Auth functions
        function switchAuthTab(tab) {
            if (tab === 'login') {
                document.getElementById('loginTab').style.display = 'block';
                document.getElementById('registerTab').style.display = 'none';
                document.querySelectorAll('.tabs .tab')[0].classList.add('active');
                document.querySelectorAll('.tabs .tab')[1].classList.remove('active');
            } else {
                document.getElementById('loginTab').style.display = 'none';
                document.getElementById('registerTab').style.display = 'block';
                document.querySelectorAll('.tabs .tab')[0].classList.remove('active');
                document.querySelectorAll('.tabs .tab')[1].classList.add('active');
            }
        }

        function register() {
            const name = document.getElementById('regName').value;
            const email = document.getElementById('regEmail').value;
            const phone = document.getElementById('regPhone').value;
            const password = document.getElementById('regPassword').value;
            const plan = document.getElementById('regPlan').value;

            if (!name || !email || !phone || !password) {
                alert('Please fill in all fields');
                return;
            }

            const user = {
                id: Date.now(),
                name,
                email,
                phone,
                password,
                plan,
                pin: '1234',
                contacts: [],
                clearedAlerts: [],
                resetToken: null,
                resetTokenExpires: null,
                createdAt: new Date().toISOString()
            };

            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            alert('Account created successfully! You can now login.');
            switchAuthTab('login');
            document.getElementById('loginEmail').value = email;
        }

        function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);
            
            if (user) {
                if (!user.clearedAlerts) user.clearedAlerts = [];
                currentUser = user;
                localStorage.setItem('currentUser', JSON.stringify(user));
                showDashboard();
            } else {
                alert('Invalid email or password');
            }
        }

        // FIX #5 - Logout doesn't clear alerts
        function logout() {
            stopLocationTracking();
            
            // Deactivate SOS if active
            if (sosActive) {
                deactivateSOS();
            }
            
            // DO NOT clear alerts - they persist globally
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('authScreen').classList.add('active');
            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('meetingDetailScreen').classList.remove('active');
            document.getElementById('emergencyBtn').style.display = 'none';
        }

        function showForgotPassword() {
            document.getElementById('forgotEmail').value = '';
            document.getElementById('forgotPasswordModal').classList.add('active');
        }

        function requestPasswordReset() {
            const email = document.getElementById('forgotEmail').value;
            
            if (!email) {
                alert('Please enter your email address');
                return;
            }

            const user = users.find(u => u.email === email);
            if (!user) {
                alert('No account found with this email address');
                return;
            }

            const resetCode = Math.floor(100000 + Math.random() * 900000).toString();
            const expiresAt = new Date(Date.now() + 3600000);

            user.resetToken = resetCode;
            user.resetTokenExpires = expiresAt.toISOString();

            const userIndex = users.findIndex(u => u.email === email);
            users[userIndex] = user;
            localStorage.setItem('users', JSON.stringify(users));

            pendingResetEmail = email;

            closeModal('forgotPasswordModal');
            alert(`Password reset code: ${resetCode}\n\n(In production, this would be sent to your email)`);
            document.getElementById('resetPasswordModal').classList.add('active');
        }

        function resetPassword() {
            const code = document.getElementById('resetCode').value;
            const newPassword = document.getElementById('resetPassword').value;

            if (!code || !newPassword) {
                alert('Please enter the reset code and new password');
                return;
            }

            if (!pendingResetEmail) {
                alert('No reset request found. Please start the password reset process again.');
                return;
            }

            const user = users.find(u => u.email === pendingResetEmail);
            if (!user) {
                alert('User not found');
                return;
            }

            if (user.resetToken !== code) {
                alert('Invalid reset code');
                return;
            }

            const now = new Date();
            const expires = new Date(user.resetTokenExpires);
            if (now > expires) {
                alert('Reset code has expired. Please request a new one.');
                return;
            }

            user.password = newPassword;
            user.resetToken = null;
            user.resetTokenExpires = null;

            const userIndex = users.findIndex(u => u.email === pendingResetEmail);
            users[userIndex] = user;
            localStorage.setItem('users', JSON.stringify(users));

            pendingResetEmail = null;
            closeModal('resetPasswordModal');
            
            alert('Password reset successfully! You can now login with your new password.');
            switchAuthTab('login');
            document.getElementById('loginEmail').value = user.email;
        }

        function showDashboard() {
            document.getElementById('authScreen').classList.remove('active');
            document.getElementById('dashboardScreen').classList.add('active');
            document.getElementById('meetingDetailScreen').classList.remove('active');
            document.getElementById('emergencyBtn').style.display = 'block';
            updateHeaderInfo();
            loadMeetings();
            loadMonitoringMeetings();
            loadContacts();
            loadAlerts();
            updateCurrentMeetingAlert();
            updateSOSButton();
            updateSOSTab();
        }

        function backToDashboard() {
            stopLocationTracking();
            showDashboard();
        }

        function updateHeaderInfo() {
            const badge = currentUser.plan === 'free' ? 'subscription-free' : 
                         currentUser.plan === 'monthly' ? 'subscription-monthly' : 'subscription-annual';
            const planText = currentUser.plan.charAt(0).toUpperCase() + currentUser.plan.slice(1);
            document.getElementById('userInfo').innerHTML = 
                `${currentUser.name} <span class="subscription-badge ${badge}">${planText}</span>`;
        }

        function switchDashTab(tab) {
            document.getElementById('meetingsTab').style.display = tab === 'meetings' ? 'block' : 'none';
            document.getElementById('monitoringTab').style.display = tab === 'monitoring' ? 'block' : 'none';
            document.getElementById('contactsTab').style.display = tab === 'contacts' ? 'block' : 'none';
            document.getElementById('alertsTab').style.display = tab === 'alerts' ? 'block' : 'none';
            document.getElementById('sosTab').style.display = tab === 'sos' ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = tab === 'settings' ? 'block' : 'none';

            const tabs = document.querySelectorAll('#dashboardScreen .tabs .tab');
            tabs.forEach(t => t.classList.remove('active'));
            if (tab === 'meetings') tabs[0].classList.add('active');
            if (tab === 'monitoring') tabs[1].classList.add('active');
            if (tab === 'contacts') tabs[2].classList.add('active');
            if (tab === 'alerts') tabs[3].classList.add('active');
            if (tab === 'sos') {
                tabs[4].classList.add('active');
                updateSOSTab();
            }
            if (tab === 'settings') tabs[5].classList.add('active');
        }

        function getMeetingStatus(meeting) {
            const now = new Date();
            const start = new Date(meeting.start);
            const end = new Date(meeting.end);
            const graceEnd = new Date(end.getTime() + GRACE_PERIOD_MS);

            if (meeting.status === 'ended' || meeting.status === 'cancelled') {
                return meeting.status;
            }

            if (now < start) {
                return 'scheduled';
            } else if (now >= start && now <= end) {
                return 'active';
            } else if (now > end && now <= graceEnd) {
                if (!meeting.grace_period_start) {
                    meeting.grace_period_start = end.toISOString();
                    saveMeetings();
                }
                return 'grace';
            } else if (now > graceEnd) {
                return 'overdue';
            }

            return meeting.status;
        }

        function updateCurrentMeetingAlert() {
            const alertDiv = document.getElementById('currentMeetingAlert');
            const now = new Date();
            
            const activeMeetings = meetings.filter(m => {
                if (m.userId !== currentUser.id) return false;
                const status = getMeetingStatus(m);
                return status === 'active' || status === 'grace' || status === 'overdue';
            });

            if (activeMeetings.length === 0) {
                alertDiv.classList.remove('show');
                activeMeetingId = null;
                return;
            }

            activeMeetings.sort((a, b) => {
                const statusA = getMeetingStatus(a);
                const statusB = getMeetingStatus(b);
                const priority = { 'overdue': 3, 'grace': 2, 'active': 1 };
                return priority[statusB] - priority[statusA];
            });

            const activeMeeting = activeMeetings[0];
            activeMeetingId = activeMeeting.id;
            
            const status = getMeetingStatus(activeMeeting);
            const endTime = new Date(activeMeeting.end);
            const graceEnd = new Date(endTime.getTime() + GRACE_PERIOD_MS);
            
            let statusClass = '';
            let dotClass = '';
            let statusText = '';

            const countText = activeMeetings.length > 1 ? ` (${activeMeetings.length} active)` : '';

            if (status === 'overdue') {
                statusClass = 'danger';
                statusText = `√∞≈∏≈°¬® MEETING OVERDUE! Mark yourself safe NOW!${countText}`;
                dotClass = 'status-red';
            } else if (status === 'grace') {
                const minutesInGrace = Math.floor((graceEnd - now) / 60000);
                statusClass = 'warning';
                statusText = `√¢≈°¬†√Ø¬∏¬è Grace period: ${minutesInGrace} min to check in${countText}`;
                dotClass = 'status-yellow';
            } else if (status === 'active') {
                const minutesRemaining = Math.floor((endTime - now) / 60000);
                if (minutesRemaining <= 5) {
                    statusClass = 'warning';
                    statusText = `Meeting ending soon - ${minutesRemaining} min remaining${countText}`;
                    dotClass = 'status-yellow';
                } else {
                    statusClass = '';
                    statusText = `Meeting in progress - ${minutesRemaining} min remaining${countText}`;
                    dotClass = 'status-green';
                }
            }
            
            alertDiv.className = 'current-meeting-alert show ' + statusClass;
            document.getElementById('meetingStatusDot').className = 'meeting-status-indicator ' + dotClass;
            document.getElementById('currentMeetingTitle').textContent = `Meeting with ${activeMeeting.person}`;
            document.getElementById('currentMeetingDetails').textContent = statusText;
        }

        function viewCurrentMeeting() {
            if (activeMeetingId) {
                viewMeetingDetail(activeMeetingId);
            }
        }

        function showCreateMeeting() {
            if (currentUser.plan === 'free') {
                alert('Free accounts can only be emergency contacts. Please upgrade to create meetings.');
                return;
            }

            if (currentUser.contacts.length < 3) {
                alert('You need at least 3 emergency contacts to create a meeting.');
                return;
            }

            document.getElementById('safetyTipsModal').classList.add('active');
        }

        function prepareCreateMeetingForm() {
            document.getElementById('meetingPerson').value = '';
            document.getElementById('meetingLocation').value = '';
            document.getElementById('meetingStart').value = '';
            document.getElementById('meetingEnd').value = '';
            document.getElementById('meetingComments').value = '';
            document.getElementById('enableTracking').checked = false;
            document.getElementById('enableAudioCapture').checked = false;
            document.getElementById('enableSMS').checked = true;

            const container = document.getElementById('contactCheckboxes');
            container.innerHTML = '';
            currentUser.contacts.forEach(contact => {
                const div = document.createElement('div');
                div.className = 'checkbox-group';
                div.innerHTML = `
                    <input type="checkbox" value="${contact.id}" id="contact_${contact.id}">
                    <label for="contact_${contact.id}">${contact.name} - ${contact.phone}</label>
                `;
                container.appendChild(div);
            });

            document.getElementById('createMeetingModal').classList.add('active');
        }

        function createMeeting() {
            const person = document.getElementById('meetingPerson').value;
            const location = document.getElementById('meetingLocation').value;
            const start = document.getElementById('meetingStart').value;
            const end = document.getElementById('meetingEnd').value;
            const comments = document.getElementById('meetingComments').value;
            const tracking = document.getElementById('enableTracking').checked;
            const audioCapture = document.getElementById('enableAudioCapture').checked;
            const sendSMS = document.getElementById('enableSMS').checked;

            const selectedContacts = [];
            currentUser.contacts.forEach(contact => {
                if (document.getElementById(`contact_${contact.id}`)?.checked) {
                    selectedContacts.push(contact);
                }
            });

            if (!person || !location || !start || !end) {
                alert('Please fill in all required fields');
                return;
            }

            if (selectedContacts.length < 3) {
                alert('Please select at least 3 emergency contacts');
                return;
            }

            const newStart = new Date(start);
            const newEnd = new Date(end);
            const newEndWithGrace = new Date(newEnd.getTime() + GRACE_PERIOD_MS);

            const userMeetings = meetings.filter(m => m.userId === currentUser.id);
            
            for (let meeting of userMeetings) {
                const status = getMeetingStatus(meeting);
                
                if (status === 'cancelled' || status === 'ended') continue;
                
                const meetingStart = new Date(meeting.start);
                const meetingEnd = new Date(meeting.end);
                const meetingEndWithGrace = new Date(meetingEnd.getTime() + GRACE_PERIOD_MS);
                
                const overlaps = (newStart < meetingEndWithGrace && newEndWithGrace > meetingStart);
                
                if (overlaps) {
                    alert(
                        `This meeting overlaps with your existing meeting:\n\n` +
                        `"${meeting.person}" at ${meeting.location}\n` +
                        `${new Date(meeting.start).toLocaleString()} - ${new Date(meeting.end).toLocaleString()}\n` +
                        `(+10 min grace period until ${meetingEndWithGrace.toLocaleTimeString()})\n\n` +
                        `Please choose a different time.`
                    );
                    return;
                }
            }

            const meeting = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.name,
                userPhone: currentUser.phone,
                person,
                location,
                start,
                end,
                comments: comments || null,
                tracking,
                audioCapture,
                sendSMS,
                contacts: selectedContacts,
                status: 'scheduled',
                grace_period_start: null,
                lastLocation: null,
                pin: Math.floor(1000 + Math.random() * 9000).toString(),
                createdAt: new Date().toISOString()
            };

            meetings.push(meeting);
            saveMeetings();
            
            closeModal('createMeetingModal');
            loadMeetings();
            alert('Meeting created successfully!' + (sendSMS ? ' SMS notifications will be sent to emergency contacts.' : ''));

            if (sendSMS) {
                sendSMSNotification(meeting, 'new_meeting');
            }
        }

        // Save comments during active meeting
        function saveComments(meetingId) {
            const newComments = document.getElementById('activeMeetingComments').value;
            
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;
            
            meeting.comments = newComments || null;
            saveMeetings();
            
            if (currentMeetingDetail && currentMeetingDetail.id === meetingId) {
                currentMeetingDetail.comments = newComments || null;
            }
            
            alert('√¢≈ì‚Ä¶ Comments saved successfully! These will be included in any alerts sent.');
        }

        // Extend meeting by 5 minutes
        function extendMeeting(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;
            
            const meetingIndex = meetings.findIndex(m => m.id === meetingId);
            
            const currentEnd = new Date(meeting.end);
            const newEnd = new Date(currentEnd.getTime() + 5 * 60 * 1000);
            
            const newEndWithGrace = new Date(newEnd.getTime() + GRACE_PERIOD_MS);
            const userMeetings = meetings.filter(m => m.userId === currentUser.id && m.id !== meetingId);
            
            for (let otherMeeting of userMeetings) {
                const status = getMeetingStatus(otherMeeting);
                if (status === 'cancelled' || status === 'ended') continue;
                
                const otherStart = new Date(otherMeeting.start);
                const otherEnd = new Date(otherMeeting.end);
                const otherEndWithGrace = new Date(otherEnd.getTime() + GRACE_PERIOD_MS);
                
                const currentStart = new Date(meeting.start);
                const overlaps = (currentStart < otherEndWithGrace && newEndWithGrace > otherStart);
                
                if (overlaps) {
                    alert('Cannot extend: This would overlap with your meeting "' + otherMeeting.person + '" scheduled at ' + otherStart.toLocaleTimeString());
                    return;
                }
            }
            
            meeting.end = newEnd.toISOString();
            meeting.grace_period_start = null;
            
            if (meeting.overdueAlertSent) {
                meeting.overdueAlertSent = false;
            }
            
            meetings[meetingIndex] = meeting;
            saveMeetings();
            
            if (currentMeetingDetail && currentMeetingDetail.id === meetingId) {
                currentMeetingDetail.end = meeting.end;
                currentMeetingDetail.grace_period_start = null;
            }
            
            alert('Meeting extended by 5 minutes! New end time: ' + newEnd.toLocaleTimeString());
            
            viewMeetingDetail(meetingId);
        }

        // FIX #3 & #4 - Past meetings in reverse chronological order with audio links
        function loadMeetings() {
            const upcomingContainer = document.getElementById('upcomingMeetingsList');
            const pastContainer = document.getElementById('pastMeetingsList');
            
            const userMeetings = meetings.filter(m => m.userId === currentUser.id);
            
            userMeetings.forEach(m => {
                const newStatus = getMeetingStatus(m);
                if (m.status !== newStatus && (newStatus === 'ended' || newStatus === 'cancelled')) {
                } else {
                    m.status = newStatus;
                }
            });
            saveMeetings();

            const upcoming = userMeetings.filter(m => {
                const status = getMeetingStatus(m);
                return status !== 'ended' && status !== 'cancelled';
            });
            
            // FIX #4 - Sort past meetings in REVERSE chronological order
            const past = userMeetings.filter(m => {
                const status = getMeetingStatus(m);
                return status === 'ended' || status === 'cancelled';
            }).sort((a, b) => new Date(b.start) - new Date(a.start)) // REVERSE CHRONOLOGICAL
              .slice(0, 10);

            if (upcoming.length === 0) {
                upcomingContainer.innerHTML = '<p style="text-align:center; color:#999; padding:20px 0;">No upcoming meetings</p>';
            } else {
                upcomingContainer.innerHTML = upcoming.map(meeting => {
                    const startTime = new Date(meeting.start).toLocaleString();
                    const endTime = new Date(meeting.end).toLocaleString();
                    const status = getMeetingStatus(meeting);
                    
                    let statusBadge = 'status-upcoming';
                    let statusText = 'SCHEDULED';
                    
                    if (status === 'active') {
                        statusBadge = 'status-active';
                        statusText = 'ACTIVE';
                    } else if (status === 'grace') {
                        statusBadge = 'status-grace';
                        statusText = 'GRACE PERIOD';
                    } else if (status === 'overdue') {
                        statusBadge = 'status-overdue';
                        statusText = '√∞≈∏≈°¬® OVERDUE';
                    }

                    return `
                        <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}">
                            <h4>Meeting with ${meeting.person}</h4>
                            <p>√∞≈∏‚Äú¬ç ${meeting.location}</p>
                            <p>√∞≈∏‚Ä¢¬ê ${startTime} - ${endTime}</p>
                            ${meeting.audioCapture ? '<p>√∞≈∏≈Ω¬§ Audio recording enabled</p>' : ''}
                            <p><span class="status-badge ${statusBadge}">${statusText}</span></p>
                            <div class="contact-actions">
                                ${status === 'active' || status === 'grace' || status === 'overdue' ? `
                                    <button class="btn btn-success btn-small" onclick="markSafe(${meeting.id})">√¢≈ì‚Äú I'm Safe</button>
                                    <button class="btn btn-danger btn-small" onclick="triggerMeetingEmergency(${meeting.id})">√∞≈∏≈°¬® Emergency!</button>
                                    <button class="btn btn-primary btn-small" onclick="viewMeetingDetail(${meeting.id})">√∞≈∏‚Äú‚Äπ View Details</button>
                                ` : `
                                    <button class="btn btn-primary btn-small" onclick="viewMeetingDetail(${meeting.id})">√∞≈∏‚Äò¬Å√Ø¬∏¬è View</button>
                                    <button class="btn btn-danger btn-small" onclick="cancelMeeting(${meeting.id})">√¢≈ì‚Äì Cancel</button>
                                `}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            if (past.length === 0) {
                pastContainer.innerHTML = '<p style="text-align:center; color:#999; padding:20px 0;">No past meetings</p>';
            } else {
                // FIX #3 - Show audio download links in past meetings
                pastContainer.innerHTML = past.map(meeting => {
                    const startTime = new Date(meeting.start).toLocaleString();
                    
                    // Get audio recordings for this meeting
                    const meetingRecordings = audioRecordings.filter(r => r.meetingId === meeting.id);
                    let audioLinksHTML = '';
                    if (meetingRecordings.length > 0) {
                        audioLinksHTML = `
                            <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px;">
                                <strong style="font-size: 12px; color: #92400e;">√∞≈∏≈Ω¬§ Audio Recordings:</strong>
                                ${meetingRecordings.map(recording => {
                                    const audioUrl = recording.serverUrl || recording.audioData;
                                    const recTime = new Date(recording.timestamp).toLocaleString();
                                    return `<div style="margin-top: 5px;"><a href="${audioUrl}" download="${recording.filename}" class="audio-file-link" style="font-size: 12px; padding: 5px 10px;">√∞≈∏‚Äù≈† ${recTime}</a></div>`;
                                }).join('')}
                            </div>
                        `;
                    }
                    
                    return `
                        <div class="meeting-card" style="opacity: 0.7;">
                            <h4>Meeting with ${meeting.person}</h4>
                            <p>√∞≈∏‚Äú¬ç ${meeting.location}</p>
                            <p>√∞≈∏‚Ä¢¬ê ${startTime}</p>
                            <p><span class="status-badge status-ended">${meeting.status.toUpperCase()}</span></p>
                            ${meeting.comments ? `<p style="color:#999; font-size:12px;">√∞≈∏‚Äú¬ù ${meeting.comments}</p>` : ''}
                            ${audioLinksHTML}
                        </div>
                    `;
                }).join('');
            }
        }

        function loadMonitoringMeetings() {
            const container = document.getElementById('monitoringMeetingsList');
            const countBadge = document.getElementById('monitoringCount');
            
            const monitoringMeetings = meetings.filter(m => {
                return m.contacts && m.contacts.some(c => 
                    c.email === currentUser.email || c.phone === currentUser.phone
                );
            });

            monitoringMeetings.forEach(m => {
                const newStatus = getMeetingStatus(m);
                m.status = newStatus;
            });

            const activeMonitoring = monitoringMeetings.filter(m => {
                const status = getMeetingStatus(m);
                return status !== 'ended' && status !== 'cancelled';
            });

            if (activeMonitoring.length > 0) {
                countBadge.textContent = activeMonitoring.length;
                countBadge.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
            }

            if (activeMonitoring.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">You are not monitoring any meetings</p>';
                return;
            }

            container.innerHTML = activeMonitoring.map(meeting => {
                const startTime = new Date(meeting.start).toLocaleString();
                const endTime = new Date(meeting.end).toLocaleString();
                const status = getMeetingStatus(meeting);
                
                let statusBadge = 'status-upcoming';
                let statusText = 'SCHEDULED';
                
                if (status === 'active') {
                    statusBadge = 'status-active';
                    statusText = 'ACTIVE NOW';
                } else if (status === 'grace') {
                    statusBadge = 'status-grace';
                    statusText = '√¢≈°¬†√Ø¬∏¬è IN GRACE PERIOD';
                } else if (status === 'overdue') {
                    statusBadge = 'status-overdue';
                    statusText = '√∞≈∏≈°¬® OVERDUE - MAY NEED HELP';
                }
                
                const hasActiveAlert = alerts.some(a => 
                    a.meetingId === meeting.id && 
                    !a.cleared &&
                    !currentUser.clearedAlerts.includes(a.id)
                );
                
                const alertBadge = hasActiveAlert ? '<span style="background:#ff4757; color:white; padding:3px 8px; border-radius:12px; font-size:11px; margin-left:8px; animation: flashAlert 0.8s infinite;">√¢≈°¬†√Ø¬∏¬è ALERT ACTIVE</span>' : '';

                return `
                    <div class="meeting-card ${status === 'overdue' || hasActiveAlert ? 'alert-flash' : ''}" style="border-left-color: ${status === 'overdue' || hasActiveAlert ? '#ef4444' : status === 'grace' ? '#f59e0b' : '#0085CA'};">
                        <h4>${meeting.userName}'s Meeting ${alertBadge}</h4>
                        <p><strong>Meeting with:</strong> ${meeting.person}</p>
                        <p>√∞≈∏‚Äú¬ç ${meeting.location}</p>
                        <p>√∞≈∏‚Ä¢¬ê ${startTime} - ${endTime}</p>
                        <p><span class="status-badge ${statusBadge}">${statusText}</span></p>
                        <div class="contact-actions">
                            <button class="btn btn-primary btn-small" onclick="viewMonitoringMeetingDetail(${meeting.id})">√∞≈∏‚Äò¬Å√Ø¬∏¬è View Details</button>
                            ${status === 'overdue' || hasActiveAlert ? `
                                <button class="btn btn-danger btn-small" onclick="callUser('${meeting.userPhone}')">√∞≈∏‚Äú≈æ Call ${meeting.userName}</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function viewMonitoringMeetingDetail(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            currentMeetingDetail = meeting;
            const status = getMeetingStatus(meeting);

            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('meetingDetailScreen').classList.add('active');

            let statusBadge = 'status-upcoming';
            let statusText = 'SCHEDULED';
            
            if (status === 'active') {
                statusBadge = 'status-active';
                statusText = 'ACTIVE NOW';
            } else if (status === 'grace') {
                statusBadge = 'status-grace';
                statusText = 'IN GRACE PERIOD';
            } else if (status === 'overdue') {
                statusBadge = 'status-overdue';
                statusText = '√∞≈∏≈°¬® OVERDUE';
            }

            let detailHTML = `
                <h2 style="color: #333; margin: 20px 0;">Monitoring: ${meeting.userName}'s Meeting</h2>
                <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}">
                    <h3>Meeting with ${meeting.person}</h3>
                    <p><strong>Location:</strong> ${meeting.location}</p>
                    <p><strong>Start:</strong> ${new Date(meeting.start).toLocaleString()}</p>
                    <p><strong>End:</strong> ${new Date(meeting.end).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${statusBadge}">${statusText}</span></p>
                    ${meeting.comments ? `<div class="comments-display"><strong>√∞≈∏‚Äú¬ù Meeting Notes:</strong> ${meeting.comments}</div>` : ''}
                    <p><strong>Organizer:</strong> ${meeting.userName}</p>
                    <p><strong>Phone:</strong> ${meeting.userPhone}</p>
                    <p><strong>All Emergency Contacts:</strong></p>
                    <ul>
                        ${meeting.contacts.map(c => `<li>${c.name} - ${c.phone}</li>`).join('')}
                    </ul>
                </div>
            `;

            if (meeting.tracking && meeting.lastLocation && meeting.lastLocation.lat) {
                const updateTime = meeting.lastLocation.time ? new Date(meeting.lastLocation.time).toLocaleString() : 'Unknown';
                detailHTML += `
                    <div class="location-status">
                        <strong>√∞≈∏‚Äú¬ç Last Known Location</strong><br>
                        <small>Updated: ${updateTime}</small>
                    </div>
                    <div class="map-container" id="mapContainer"></div>
                    <div class="map-info" id="mapInfo">
                        <strong>Loading map...</strong>
                    </div>
                `;
            }

            // Show audio recordings for this meeting
            const meetingRecordings = audioRecordings.filter(r => r.meetingId === meeting.id);
            if (meetingRecordings.length > 0) {
                detailHTML += `
                    <div style="margin-top: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">√∞≈∏≈Ω¬§ Emergency Audio Recordings</h4>
                        ${meetingRecordings.map(recording => {
                            const time = new Date(recording.timestamp).toLocaleString();
                            const audioUrl = recording.serverUrl || recording.audioData;
                            return `
                                <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">${time}</p>
                                    <p style="font-size: 14px; color: #333; margin-bottom: 5px;"><strong>Transcription:</strong> "${recording.transcription}"</p>
                                    ${audioUrl ? `<a href="${audioUrl}" download="${recording.filename}" class="audio-file-link">√∞≈∏‚Äù≈† Download Audio</a>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            if (status === 'overdue') {
                detailHTML += `
                    <div style="margin-top: 20px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 10px;">
                        <strong style="color: #dc2626;">√¢≈°¬†√Ø¬∏¬è This meeting is overdue!</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">The organizer has not checked in after the grace period. Consider calling them to ensure they are safe.</p>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-danger" onclick="callUser('${meeting.userPhone}')">√∞≈∏‚Äú≈æ Call ${meeting.userName} Now</button>
                    </div>
                `;
            }

            document.getElementById('meetingDetailContent').innerHTML = detailHTML;

            if (meeting.tracking && meeting.lastLocation && meeting.lastLocation.lat) {
                setTimeout(() => {
                    initializeMap(meeting.lastLocation.lat, meeting.lastLocation.lng, true);
                }, 100);
            }
        }

        function viewMeetingDetail(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            currentMeetingDetail = meeting;
            const status = getMeetingStatus(meeting);
            const isActive = status === 'active' || status === 'grace' || status === 'overdue';
            const isOwner = meeting.userId === currentUser.id;

            document.getElementById('dashboardScreen').classList.remove('active');
            document.getElementById('meetingDetailScreen').classList.add('active');

            let statusBadge = 'status-upcoming';
            let statusText = 'SCHEDULED';
            
            if (status === 'active') {
                statusBadge = 'status-active';
                statusText = 'ACTIVE';
            } else if (status === 'grace') {
                statusBadge = 'status-grace';
                statusText = 'GRACE PERIOD';
            } else if (status === 'overdue') {
                statusBadge = 'status-overdue';
                statusText = '√∞≈∏≈°¬® OVERDUE';
            } else if (status === 'ended') {
                statusBadge = 'status-ended';
                statusText = 'ENDED';
            }

            let detailHTML = `
                <h2 style="color: #333; margin: 20px 0;">Meeting Details</h2>
                <div class="meeting-card ${status === 'overdue' ? 'alert-flash' : ''}">
                    <h3>${meeting.person}</h3>
                    <p><strong>Location:</strong> ${meeting.location}</p>
                    <p><strong>Start:</strong> ${new Date(meeting.start).toLocaleString()}</p>
                    <p><strong>End:</strong> ${new Date(meeting.end).toLocaleString()}</p>
                    <p><strong>Status:</strong> <span class="status-badge ${statusBadge}">${statusText}</span></p>
                    <div style="background: #e0f2fe; border: 3px solid #0085CA; padding: 15px; border-radius: 10px; margin: 15px 0; text-align: center;">
                        <strong style="color: #0085CA; font-size: 14px; display: block; margin-bottom: 5px;">√∞≈∏‚Äù¬ê Safety PIN</strong>
                        <span style="font-size: 32px; font-weight: bold; color: #0085CA; letter-spacing: 8px;">${meeting.pin}</span>
                        <p style="margin: 10px 0 0 0; font-size: 12px; color: #666;">Emergency contacts need this PIN to clear alerts</p>
                    </div>
                    ${isActive && isOwner ? `
                        <div class="editable-comments-box">
                            <label>Meeting Comments (editable while active) √¢≈ì¬è√Ø¬∏¬è</label>
                            <textarea id="activeMeetingComments" style="min-height: 100px; background: white;">${meeting.comments || ''}</textarea>
                            <button class="btn btn-primary btn-small" onclick="saveComments(${meeting.id})" style="margin-top: 10px;">√∞≈∏‚Äô¬æ Save Comments</button>
                            <p style="color: #92400e; font-size: 12px; margin-top: 8px;">√∞≈∏‚Äô¬° Updated comments will be included in any alerts sent to emergency contacts</p>
                        </div>
                    ` : meeting.comments ? `<div class="comments-display"><strong>√∞≈∏‚Äú¬ù Comments:</strong> ${meeting.comments}</div>` : ''}
                    <p><strong>Organizer:</strong> ${meeting.userName} (${meeting.userPhone})</p>
                    <p><strong>Emergency Contacts:</strong></p>
                    <ul>
                        ${meeting.contacts.map(c => `<li>${c.name} - ${c.phone}</li>`).join('')}
                    </ul>
                    ${meeting.tracking ? '<p><strong>√∞≈∏‚Äú¬ç Location Tracking:</strong> Enabled</p>' : ''}
                    ${meeting.audioCapture ? '<p><strong>√∞≈∏≈Ω¬§ Audio Recording:</strong> Enabled</p>' : ''}
                    ${meeting.sendSMS ? '<p><strong>√∞≈∏‚Äú¬± SMS Notifications:</strong> Enabled</p>' : ''}
                </div>
            `;

            // Audio capture box for active meetings with audio enabled
            if (meeting.audioCapture && isActive && isOwner) {
                detailHTML += `
                    <div class="audio-capture-box" id="audioCaptureBox">
                        <div class="audio-capture-status">
                            <div class="recording-indicator" id="recordingIndicator" style="display:none;"></div>
                            <strong style="color: #92400e;">√∞≈∏≈Ω¬§ Emergency Audio Recording</strong>
                        </div>
                        <p style="color: #92400e; font-size: 13px; margin-bottom: 10px;">
                            When you press the emergency button, 60 seconds of audio will be automatically recorded and transcribed, then sent to your emergency contacts.
                        </p>
                        <div id="liveTranscription" class="transcription-display empty">
                            Transcription will appear here during recording...
                        </div>
                    </div>
                `;
            }

            // Show existing audio recordings for this meeting
            const meetingRecordings = audioRecordings.filter(r => r.meetingId === meeting.id);
            if (meetingRecordings.length > 0) {
                detailHTML += `
                    <div style="margin-top: 20px; background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #92400e; margin-bottom: 10px;">√∞≈∏≈Ω¬§ Previous Audio Recordings</h4>
                        ${meetingRecordings.map(recording => {
                            const time = new Date(recording.timestamp).toLocaleString();
                            const audioUrl = recording.serverUrl || recording.audioData;
                            return `
                                <div style="background: white; padding: 10px; border-radius: 6px; margin-bottom: 10px;">
                                    <p style="font-size: 12px; color: #666; margin-bottom: 5px;">${time} - ${recording.alertType.toUpperCase()}</p>
                                    <p style="font-size: 14px; color: #333; margin-bottom: 5px;"><strong>Transcription:</strong> "${recording.transcription}"</p>
                                    ${audioUrl ? `<a href="${audioUrl}" download="${recording.filename}" class="audio-file-link">√∞≈∏‚Äù≈† Download Audio</a>` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            if (meeting.tracking && isActive && isOwner) {
                detailHTML += `
                    <div class="location-status" id="locationStatus">
                        <strong>√∞≈∏‚Äú¬ç Location Tracking Active</strong><br>
                        <small>Requesting your location...</small>
                    </div>
                    <div class="map-container" id="mapContainer"></div>
                    <div class="map-info" id="mapInfo">
                        <strong>Map will appear once GPS lock is obtained...</strong>
                    </div>
                `;
            } else if (meeting.tracking && meeting.lastLocation) {
                detailHTML += `
                    <div class="location-status">
                        <strong>√∞≈∏‚Äú¬ç Last Known Location</strong><br>
                        <small>Updated: ${meeting.lastLocation.time ? new Date(meeting.lastLocation.time).toLocaleString() : 'Unknown'}</small>
                    </div>
                    <div class="map-container" id="mapContainer"></div>
                    <div class="map-info" id="mapInfo">
                        <strong>Loading map...</strong>
                    </div>
                `;
            }

            if (status === 'overdue' && isOwner) {
                detailHTML += `
                    <div style="margin-top: 20px; padding: 15px; background: #fee2e2; border-left: 4px solid #dc2626; border-radius: 10px;">
                        <strong style="color: #dc2626;">√∞≈∏≈°¬® URGENT: Meeting Overdue!</strong>
                        <p style="margin: 5px 0 0 0; color: #666;">You have exceeded your grace period. Please mark yourself safe immediately or trigger emergency alert if needed.</p>
                    </div>
                `;
            }

            if (isActive && isOwner) {
                detailHTML += `
                    <div style="margin-top: 20px;">
                        <button class="btn btn-success" onclick="markSafe(${meeting.id})">√¢≈ì‚Äú Mark Myself Safe</button>
                        <button class="btn btn-danger" onclick="triggerMeetingEmergency(${meeting.id})">√∞≈∏≈°¬® Emergency!</button>
                    </div>
                    <div style="margin-top: 15px; background: #fef3c7; border-left: 4px solid #f59e0b; padding: 15px; border-radius: 10px;">
                        <p style="color: #92400e; font-size: 14px; margin-bottom: 10px;"><strong>√¢¬è¬±√Ø¬∏¬è Need More Time?</strong> Extend this meeting to push out the grace period and prevent overdue alerts.</p>
                        <button class="btn btn-warning btn-small" onclick="extendMeeting(${meeting.id})">+5 Min</button>
                        <span style="color: #92400e; font-size: 12px; margin-left: 10px;">Current end: ${new Date(meeting.end).toLocaleTimeString()}</span>
                    </div>
                `;
            }

            document.getElementById('meetingDetailContent').innerHTML = detailHTML;

            if (meeting.tracking) {
                if (isActive && isOwner) {
                    startLocationTracking(meeting);
                } else if (meeting.lastLocation && meeting.lastLocation.lat) {
                    setTimeout(() => {
                        initializeMap(meeting.lastLocation.lat, meeting.lastLocation.lng, true);
                    }, 100);
                }
            }
        }

        function initializeMap(lat, lng, isMonitoring = false) {
            if (meetingMap) {
                meetingMap.remove();
            }

            meetingMap = L.map('mapContainer').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '√Ç¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(meetingMap);

            const markerColor = isMonitoring ? 'red' : 'blue';
            meetingMapMarker = L.marker([lat, lng]).addTo(meetingMap)
                .bindPopup(isMonitoring ? 'Last Known Location' : 'Your Current Location')
                .openPopup();

            const mapInfoText = isMonitoring 
                ? `√∞≈∏‚Äú¬ç This is the person's last known location. Updated: ${new Date().toLocaleString()}`
                : `√∞≈∏‚Äú¬ç Your current location is being tracked. This updates automatically.`;
            
            document.getElementById('mapInfo').innerHTML = `
                <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                <small>${mapInfoText}</small><br>
                <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color: #0085CA; font-weight: 600; margin-top: 5px; display: inline-block;">√∞≈∏‚Äú¬ç Open in Google Maps √¢‚Ä†‚Äô</a>
            `;

            setTimeout(() => {
                meetingMap.invalidateSize();
            }, 100);
        }

        function updateMap(lat, lng) {
            if (meetingMap && meetingMapMarker) {
                meetingMapMarker.setLatLng([lat, lng]);
                meetingMap.setView([lat, lng], meetingMap.getZoom());
                meetingMapMarker.setPopupContent('Your Current Location');
                
                document.getElementById('mapInfo').innerHTML = `
                    <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                    <small>√∞≈∏‚Äú¬ç Your current location is being tracked. Updated: ${new Date().toLocaleTimeString()}</small><br>
                    <a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" style="color: #0085CA; font-weight: 600; margin-top: 5px; display: inline-block;">√∞≈∏‚Äú¬ç Open in Google Maps √¢‚Ä†‚Äô</a>
                `;
            } else {
                initializeMap(lat, lng);
            }
        }

        function startLocationTracking(meeting) {
            if (!navigator.geolocation) {
                alert('Geolocation is not supported by your browser');
                return;
            }

            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('locationStatus').innerHTML = `
                        <strong>√∞≈∏‚Äú¬ç Location Tracking Active</strong><br>
                        <small>Last update: ${new Date().toLocaleTimeString()}</small>
                    `;

                    updateMap(lat, lng);

                    if (currentMeetingDetail) {
                        currentMeetingDetail.lastLocation = {
                            lat: lat,
                            lng: lng,
                            time: new Date().toISOString()
                        };
                        
                        const meetingIndex = meetings.findIndex(m => m.id === currentMeetingDetail.id);
                        if (meetingIndex !== -1) {
                            meetings[meetingIndex] = currentMeetingDetail;
                            saveMeetings();
                        }
                    }
                },
                (error) => {
                    console.error('Geolocation error:', error);
                    document.getElementById('locationStatus').innerHTML = `
                        <strong>√¢≈°¬†√Ø¬∏¬è Location Error</strong><br>
                        <small>${error.message}. Please check permissions.</small>
                    `;
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 30000,
                    timeout: 27000
                }
            );
        }

        function stopLocationTracking() {
            if (locationWatchId) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
            }
            if (meetingMap) {
                meetingMap.remove();
                meetingMap = null;
                meetingMapMarker = null;
            }
        }

        function cancelMeeting(meetingId) {
            if (!confirm('Are you sure you want to cancel this meeting?')) {
                return;
            }

            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            meeting.status = 'cancelled';
            saveMeetings();
            
            if (meeting.sendSMS) {
                sendSMSNotification(meeting, 'cancelled');
            }

            loadMeetings();
            loadMonitoringMeetings();
            alert('Meeting cancelled. Emergency contacts have been notified.');
        }

        function markSafe(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            meeting.status = 'ended';
            saveMeetings();
            
            alerts.forEach(alert => {
                if (alert.meetingId === meetingId || (alert.userId === currentUser.id && !alert.meetingId)) {
                    alert.cleared = true;
                    alert.clearedAt = new Date().toISOString();
                    alert.clearedBy = 'organizer_safe';
                }
            });
            saveAlertsGlobally();
            
            if (meeting.sendSMS) {
                sendSMSNotification(meeting, 'safe');
            }

            stopLocationTracking();
            alert('Great! Meeting marked as ended safely. All alerts cleared.');
            showDashboard();
        }

        function showAddContact() {
            if (currentUser.plan === 'free') {
                alert('Free accounts cannot add contacts. Please upgrade to add emergency contacts.');
                return;
            }
            
            editingContactId = null;
            document.getElementById('contactName').value = '';
            document.getElementById('contactEmail').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactRelation').value = '';
            
            document.querySelector('#addContactModal h2').textContent = 'Add Emergency Contact';
            document.getElementById('addContactModal').classList.add('active');
        }

        function addContact() {
            const name = document.getElementById('contactName').value;
            const email = document.getElementById('contactEmail').value;
            const phone = document.getElementById('contactPhone').value;
            const relation = document.getElementById('contactRelation').value;

            if (!name || !email || !phone) {
                alert('Please fill in name, email, and phone');
                return;
            }

            if (editingContactId) {
                const contactIndex = currentUser.contacts.findIndex(c => c.id === editingContactId);
                if (contactIndex !== -1) {
                    currentUser.contacts[contactIndex] = {
                        ...currentUser.contacts[contactIndex],
                        name,
                        email,
                        phone,
                        relation
                    };
                    alert('Contact updated successfully!');
                }
                editingContactId = null;
            } else {
                const contact = {
                    id: Date.now(),
                    name,
                    email,
                    phone,
                    relation
                };
                currentUser.contacts.push(contact);
                alert('Contact added successfully!');
            }

            const userIndex = users.findIndex(u => u.id === currentUser.id);
            users[userIndex] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            closeModal('addContactModal');
            loadContacts();
        }

        function editContact(contactId) {
            const contact = currentUser.contacts.find(c => c.id === contactId);
            if (!contact) return;

            editingContactId = contactId;
            
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactEmail').value = contact.email;
            document.getElementById('contactPhone').value = contact.phone;
            document.getElementById('contactRelation').value = contact.relation || '';
            
            document.querySelector('#addContactModal h2').textContent = 'Edit Emergency Contact';
            document.getElementById('addContactModal').classList.add('active');
        }

        function removeContact(contactId) {
            if (!confirm('Are you sure you want to remove this contact?')) {
                return;
            }

            currentUser.contacts = currentUser.contacts.filter(c => c.id !== contactId);
            
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            users[userIndex] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            loadContacts();
        }

        function loadContacts() {
            const container = document.getElementById('contactsList');

            if (currentUser.contacts.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">No emergency contacts added</p>';
                return;
            }

            container.innerHTML = currentUser.contacts.map(contact => `
                <div class="contact-card">
                    <h4>${contact.name}</h4>
                    <p>√∞≈∏‚Äú¬ß ${contact.email}</p>
                    <p>√∞≈∏‚Äú¬± ${contact.phone}</p>
                    ${contact.relation ? `<p>Relationship: ${contact.relation}</p>` : ''}
                    <div class="contact-actions">
                        <button class="btn btn-primary btn-small" onclick="editContact(${contact.id})">√¢≈ì¬è√Ø¬∏¬è Edit</button>
                        <button class="btn btn-danger btn-small" onclick="removeContact(${contact.id})">√∞≈∏‚Äî‚Äò√Ø¬∏¬è Remove</button>
                    </div>
                </div>
            `).join('');
        }

        function loadAlerts() {
            if (!currentUser.clearedAlerts) currentUser.clearedAlerts = [];
            
            const container = document.getElementById('alertsList');
            const countBadge = document.getElementById('alertCount');
            const alertsTab = document.querySelectorAll('#dashboardScreen .tabs .tab')[3];
            
            const userAlerts = alerts.filter(a => {
                if (currentUser.clearedAlerts.includes(a.id)) return false;
                if (a.cleared) return false;
                return a.userId === currentUser.id || 
                       a.contacts.some(c => c.email === currentUser.email);
            });

            if (userAlerts.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#999; padding:40px 0;">No active alerts</p>';
                countBadge.style.display = 'none';
                alertsTab.classList.remove('alert-active');
                return;
            }

            countBadge.textContent = userAlerts.length;
            countBadge.style.display = 'inline-block';
            alertsTab.classList.add('alert-active');

            container.innerHTML = userAlerts.map(alert => {
                const isMyAlert = alert.userId === currentUser.id;
                const canClear = !isMyAlert && alert.contacts.some(c => c.email === currentUser.email);
                
                let alertTypeLabel = 'Safety Alert';
                if (alert.type === 'emergency') {
                    alertTypeLabel = 'EMERGENCY ALERT';
                } else if (alert.type === 'overdue') {
                    alertTypeLabel = 'OVERDUE ALERT';
                }

                return `
                    <div class="meeting-card alert-flash" style="border-left-color: #ff4757;">
                        <h4>√¢≈°¬†√Ø¬∏¬è ${alertTypeLabel}</h4>
                        <p><strong>${alert.userName}</strong> may need help!</p>
                        ${alert.meetingPerson ? `<p>Meeting with: ${alert.meetingPerson}</p>` : ''}
                        ${alert.location ? `<p>Meeting Location: ${alert.location}</p>` : ''}
                        ${alert.currentLocation ? `<p>Last GPS: ${alert.currentLocation}</p>` : ''}
                        <p>Time: ${new Date(alert.timestamp).toLocaleString()}</p>
                        <p style="font-size: 12px; color: #666; font-style: italic;">Alert Type: ${alert.type}</p>
                        <div class="contact-actions">
                            ${canClear ? `
                                <button class="btn btn-primary btn-small" onclick="viewAlertDetail(${alert.id})">√∞≈∏‚Äù¬ç View on Map</button>
                                <button class="btn btn-danger btn-small" onclick="callUser('${alert.userPhone}')">√∞≈∏‚Äú≈æ Call Now</button>
                                <button class="btn btn-secondary btn-small" onclick="clearAlert(${alert.id})">√¢≈ì‚Äú Clear Alert</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function triggerEmergency() {
            if (!confirm('This will alert all your emergency contacts. Are you in danger?')) {
                return;
            }

            const alert = {
                id: Date.now(),
                userId: currentUser.id,
                userName: currentUser.name,
                userPhone: currentUser.phone,
                type: 'emergency',
                contacts: currentUser.contacts,
                timestamp: new Date().toISOString(),
                lastLocation: null
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    alert.lastLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    alert.currentLocation = `${position.coords.latitude}, ${position.coords.longitude}`;
                    alerts.push(alert);
                    saveAlertsGlobally();
                    sendSMSEmergency(alert);
                });
            } else {
                alerts.push(alert);
                saveAlertsGlobally();
                sendSMSEmergency(alert);
            }

            alert('Emergency alert sent to all contacts!');
            loadAlerts();
        }

        // FIX #1 - Emergency alert audio/transcription now saves correctly
        async function triggerMeetingEmergency(meetingId) {
            const meeting = meetings.find(m => m.id === meetingId);
            if (!meeting) return;

            console.log('Triggering meeting emergency for meeting:', meetingId);

            const emergencyAlert = {
                id: Date.now(),
                meetingId: meetingId,
                userId: currentUser.id,
                userName: currentUser.name,
                userPhone: currentUser.phone,
                meetingPerson: meeting.person,
                location: meeting.location,
                meetingPin: meeting.pin,
                type: 'emergency',
                contacts: meeting.contacts,
                timestamp: new Date().toISOString(),
                lastLocation: meeting.lastLocation,
                cleared: false
            };

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    emergencyAlert.lastLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    emergencyAlert.currentLocation = `${position.coords.latitude}, ${position.coords.longitude}`;
                    alerts.push(emergencyAlert);
                    saveAlertsGlobally();
                    
                    if (meeting.sendSMS) {
                        sendSMSEmergency(emergencyAlert);
                    }
                });
            } else {
                if (meeting.lastLocation) {
                    emergencyAlert.currentLocation = `${meeting.lastLocation.lat}, ${meeting.lastLocation.lng}`;
                }
                alerts.push(emergencyAlert);
                saveAlertsGlobally();
                
                if (meeting.sendSMS) {
                    sendSMSEmergency(emergencyAlert);
                }
            }

            // FIX #1 - Start audio recording if enabled (with correct meetingId)
            if (meeting.audioCapture) {
                console.log('Starting audio recording for emergency alert');
                await startAudioRecording(meetingId, 'emergency');
                alert('Emergency alert sent to selected contacts! Audio recording started.');
            } else {
                alert('Emergency alert sent to selected contacts!');
            }
            
            loadAlerts();
        }

        function sendSMSNotification(meeting, type) {
            const safeMeetURL = getSafeMeetURL();
            
            const messages = {
                'new_meeting': `SafeMeet Alert: ${meeting.userName} has a meeting with ${meeting.person} at ${meeting.location} on ${new Date(meeting.start).toLocaleString()}. You are listed as an emergency contact. Monitor their safety.${meeting.comments ? ' Notes: ' + meeting.comments : ''} Safety PIN: ${meeting.pin} | View on SafeMeet: ${safeMeetURL}`,
                'cancelled': `SafeMeet: ${meeting.userName}'s meeting with ${meeting.person} has been cancelled. | ${safeMeetURL}`,
                'safe': `SafeMeet: ${meeting.userName} has checked in safe from their meeting with ${meeting.person}. | ${safeMeetURL}`
            };

            const message = messages[type] || 'SafeMeet notification';
            
            console.log('Sending SMS to emergency contacts:');
            meeting.contacts.forEach(contact => {
                console.log(`To: ${contact.phone} - Message: ${message}`);
                simulateSMS(contact.phone, message);
            });
        }

        function sendSMSEmergency(alert) {
            const safeMeetURL = getSafeMeetURL();
            let locationInfo = '';
            let googleMapsLink = '';
            
            if (alert.lastLocation && alert.lastLocation.lat) {
                locationInfo = ` Current GPS location: ${alert.lastLocation.lat.toFixed(6)}, ${alert.lastLocation.lng.toFixed(6)}`;
                googleMapsLink = ` View location on map: https://www.google.com/maps?q=${alert.lastLocation.lat},${alert.lastLocation.lng}`;
            } else if (alert.currentLocation) {
                locationInfo = ` Last known location: ${alert.currentLocation}`;
                const coords = alert.currentLocation.split(', ');
                if (coords.length === 2) {
                    googleMapsLink = ` View location on map: https://www.google.com/maps?q=${coords[0]},${coords[1]}`;
                }
            }
            
            const meetingInfo = alert.meetingPerson ? ` Meeting with: ${alert.meetingPerson} at ${alert.location}.` : '';
            const pinInfo = alert.meetingPin ? ` Safety PIN: ${alert.meetingPin}` : '';
            
            let commentsInfo = '';
            if (alert.meetingId) {
                const meeting = meetings.find(m => m.id === alert.meetingId);
                if (meeting && meeting.comments) {
                    commentsInfo = ` NOTES: ${meeting.comments}`;
                }
            }
            
            const message = `√∞≈∏≈°¬® EMERGENCY: ${alert.userName} needs help!${meetingInfo}${commentsInfo}${locationInfo}${googleMapsLink} Call them immediately at ${alert.userPhone}${pinInfo} | View on SafeMeet: ${safeMeetURL}`;

            console.log('Sending EMERGENCY SMS:');
            alert.contacts.forEach(contact => {
                console.log(`To: ${contact.phone} - Message: ${message}`);
                simulateSMS(contact.phone, message);
            });
        }

        function simulateSMS(phone, message) {
            console.log(`SMS to ${phone}: ${message}`);
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('SMS Sent', {
                    body: `Message sent to ${phone}`,
                    icon: '√∞≈∏‚Ä∫¬°√Ø¬∏¬è'
                });
            }
        }

        function checkActiveMeetings() {
    const now = new Date();
    let hasChanges = false;

    meetings.forEach(meeting => {
        const oldStatus = meeting.status;
        const newStatus = getMeetingStatus(meeting);
        
        if (oldStatus !== newStatus) {
            hasChanges = true;
            
            if (meeting.userId === currentUser?.id) {
                if (newStatus === 'active') {
                    notifyUser(`Your meeting with ${meeting.person} has started! Stay safe.`);
                } else if (newStatus === 'grace') {
                    notifyUser(`Your meeting with ${meeting.person} has ended. You have 10 minutes to check in.`);
                } else if (newStatus === 'overdue') {
                    notifyUser(`√¢≈°¬†√Ø¬∏¬è URGENT: You are past your grace period for meeting with ${meeting.person}! Mark yourself safe NOW!`);
                    
                    // FIXED: Check if SMS should be sent
                    if (meeting.sendSMS && !meeting.overdueAlertSent) {
                        console.log('√∞≈∏≈°¬® TRIGGERING OVERDUE SMS for meeting:', meeting.id);
                        
                        const existingOverdueAlert = alerts.find(a => 
                            a.meetingId === meeting.id && 
                            a.type === 'overdue' &&
                            !a.cleared
                        );
                        
                        if (!existingOverdueAlert) {
                            const overdueAlert = {
                                id: Date.now(),
                                meetingId: meeting.id,
                                userId: meeting.userId,
                                userName: meeting.userName,
                                userPhone: meeting.userPhone,
                                meetingPerson: meeting.person,
                                location: meeting.location,
                                type: 'overdue',
                                contacts: meeting.contacts,
                                timestamp: new Date().toISOString(),
                                lastLocation: meeting.lastLocation,
                                cleared: false
                            };
                            
                            alerts.push(overdueAlert);
                            localStorage.setItem('alerts', JSON.stringify(alerts));
                            
                            const safeMeetURL = getSafeMeetURL();
                            let locationInfo = '';
                            let googleMapsLink = '';
                            
                            if (meeting.lastLocation && meeting.lastLocation.lat) {
                                const updateTime = meeting.lastLocation.time ? new Date(meeting.lastLocation.time).toLocaleString() : 'Unknown';
                                locationInfo = ` Last GPS location: ${meeting.lastLocation.lat.toFixed(6)}, ${meeting.lastLocation.lng.toFixed(6)} (Updated: ${updateTime}).`;
                                googleMapsLink = ` Track location: https://www.google.com/maps?q=${meeting.lastLocation.lat},${meeting.lastLocation.lng}`;
                            }
                            
                            // Include comments in overdue alert
                            const commentsInfo = meeting.comments ? ` NOTES: ${meeting.comments}` : '';
                            const alertMessage = `√∞≈∏≈°¬® ALERT: ${meeting.userName} has not checked in after their meeting with ${meeting.person} at ${meeting.location}. Meeting ended at ${new Date(meeting.end).toLocaleString()}. They may need assistance.${commentsInfo}${locationInfo}${googleMapsLink} Contact them at ${meeting.userPhone} Safety PIN: ${meeting.pin} | View on SafeMeet: ${safeMeetURL}`;
                            
                            console.log('√∞≈∏‚Äú¬± SENDING OVERDUE SMS TO CONTACTS:');
                            meeting.contacts.forEach(contact => {
                                console.log(`   To: ${contact.phone}`);
                                console.log(`   Message: ${alertMessage}`);
                                simulateSMS(contact.phone, alertMessage);
                            });
                            
                            meeting.overdueAlertSent = true;
                            console.log('√¢≈ì‚Ä¶ Overdue alert sent and flag set');
                        } else {
                            console.log('√¢‚Äû¬π√Ø¬∏¬è Overdue alert already exists for this meeting');
                        }
                    } else {
                        if (!meeting.sendSMS) {
                            console.log('√¢‚Äû¬π√Ø¬∏¬è SMS disabled for this meeting');
                        }
                        if (meeting.overdueAlertSent) {
                            console.log('√¢‚Äû¬π√Ø¬∏¬è Overdue SMS already sent for this meeting');
                        }
                    }
                }
            }
        }
    });

    if (hasChanges) {
        saveMeetings();
        if (currentUser) {
            loadMeetings();
            loadMonitoringMeetings();
            updateCurrentMeetingAlert();
            loadAlerts();
        }
    }
}
		
		
        function notifyUser(message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('SafeMeet', { body: message });
            } else {
                alert(message);
            }
        }

        function saveMeetings() {
            localStorage.setItem('meetings', JSON.stringify(meetings));
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        document.getElementById('acknowledgeSafety')?.addEventListener('change', function() {
            const proceedBtn = document.getElementById('proceedToMeetingBtn');
            if (this.checked) {
                proceedBtn.disabled = false;
                proceedBtn.style.opacity = '1';
            } else {
                proceedBtn.disabled = true;
                proceedBtn.style.opacity = '0.5';
            }
        });

        function acknowledgeSafetyTips() {
            const acknowledged = document.getElementById('acknowledgeSafety').checked;
            
            if (!acknowledged) {
                alert('Please acknowledge that you have read the safety tips.');
                return;
            }
            
            closeModal('safetyTipsModal');
            
            document.getElementById('acknowledgeSafety').checked = false;
            document.getElementById('proceedToMeetingBtn').disabled = true;
            document.getElementById('proceedToMeetingBtn').style.opacity = '0.5';
            
            prepareCreateMeetingForm();
        }

        function callUser(phone) {
            if (confirm(`Call ${phone}?`)) {
                window.location.href = 'tel:' + phone;
            }
        }

        function viewLocation(lat, lng) {
            window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank');
        }

        function showEditAccount() {
            document.getElementById('editName').value = currentUser.name;
            document.getElementById('editEmail').value = currentUser.email;
            document.getElementById('editPhone').value = currentUser.phone;
            document.getElementById('editPassword').value = '';
            document.getElementById('editAccountModal').classList.add('active');
        }

        function saveAccountChanges() {
            const name = document.getElementById('editName').value;
            const email = document.getElementById('editEmail').value;
            const phone = document.getElementById('editPhone').value;
            const password = document.getElementById('editPassword').value;

            if (!name || !email || !phone) {
                alert('Please fill in all required fields');
                return;
            }

            currentUser.name = name;
            currentUser.email = email;
            currentUser.phone = phone;
            if (password) {
                currentUser.password = password;
            }

            const userIndex = users.findIndex(u => u.id === currentUser.id);
            users[userIndex] = currentUser;
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            closeModal('editAccountModal');
            updateHeaderInfo();
            alert('Account information updated successfully!');
        }

        function showChangePlan() {
            const planText = currentUser.plan.charAt(0).toUpperCase() + currentUser.plan.slice(1);
            document.getElementById('currentPlanDisplay').textContent = planText;
            document.getElementById('newPlan').value = currentUser.plan;
            document.getElementById('changePlanModal').classList.add('active');
        }

        function changePlan() {
            const newPlan = document.getElementById('newPlan').value;
            
            if (newPlan === currentUser.plan) {
                alert('This is already your current plan.');
                return;
            }

            if (newPlan === 'free' && meetings.some(m => m.userId === currentUser.id && m.status !== 'ended' && m.status !== 'cancelled')) {
                alert('Cannot downgrade to Free plan while you have active meetings. Please end or cancel all meetings first.');
                return;
            }

            if (confirm(`Change your plan to ${newPlan}?`)) {
                currentUser.plan = newPlan;

                const userIndex = users.findIndex(u => u.id === currentUser.id);
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                closeModal('changePlanModal');
                updateHeaderInfo();
                alert('Subscription plan updated successfully!');
            }
        }

        function exportContacts() {
            if (currentUser.contacts.length === 0) {
                alert('No contacts to export');
                return;
            }

            const dataStr = JSON.stringify(currentUser.contacts, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `safemeet-contacts-${currentUser.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${currentUser.contacts.length} contacts successfully!`);
        }

        function importContacts(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedContacts = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedContacts)) {
                        alert('Invalid contacts file format');
                        return;
                    }

                    let addedCount = 0;
                    let skippedCount = 0;

                    importedContacts.forEach(contact => {
                        if (contact.name && contact.email && contact.phone) {
                            const exists = currentUser.contacts.some(c => c.email === contact.email);
                            if (!exists) {
                                currentUser.contacts.push({
                                    ...contact,
                                    id: Date.now() + Math.random()
                                });
                                addedCount++;
                            } else {
                                skippedCount++;
                            }
                        }
                    });

                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    users[userIndex] = currentUser;
                    localStorage.setItem('users', JSON.stringify(users));
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));

                    loadContacts();
                    alert(`Import complete!\nAdded: ${addedCount} contacts\nSkipped (duplicates): ${skippedCount} contacts`);
                } catch (error) {
                    alert('Error reading contacts file. Please ensure it is a valid JSON file.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function exportMeetings() {
            const userMeetings = meetings.filter(m => m.userId === currentUser.id);
            
            if (userMeetings.length === 0) {
                alert('No meetings to export');
                return;
            }

            const dataStr = JSON.stringify(userMeetings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `safemeet-meetings-${currentUser.name.replace(/\s+/g, '-')}-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            alert(`Exported ${userMeetings.length} meetings successfully!`);
        }

        function importMeetings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedMeetings = JSON.parse(e.target.result);
                    
                    if (!Array.isArray(importedMeetings)) {
                        alert('Invalid meetings file format');
                        return;
                    }

                    let addedCount = 0;
                    let skippedCount = 0;

                    importedMeetings.forEach(meeting => {
                        if (meeting.person && meeting.location && meeting.start && meeting.end) {
                            const exists = meetings.some(m => m.id === meeting.id);
                            if (!exists) {
                                meetings.push({
                                    ...meeting,
                                    userId: currentUser.id,
                                    userName: currentUser.name,
                                    userPhone: currentUser.phone
                                });
                                addedCount++;
                            } else {
                                skippedCount++;
                            }
                        }
                    });

                    saveMeetings();
                    loadMeetings();
                    alert(`Import complete!\nAdded: ${addedCount} meetings\nSkipped (duplicates): ${skippedCount} meetings`);
                } catch (error) {
                    alert('Error reading meetings file. Please ensure it is a valid JSON file.');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        }

        function viewAlertDetail(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (!alert) return;

            let detailHTML = `
                <div class="meeting-card" style="border-left-color: #ff4757;">
                    <h3>√¢≈°¬†√Ø¬∏¬è Emergency Alert Details</h3>
                    <p><strong>Person:</strong> ${alert.userName}</p>
                    <p><strong>Phone:</strong> ${alert.userPhone}</p>
                    ${alert.meetingPerson ? `<p><strong>Meeting with:</strong> ${alert.meetingPerson}</p>` : ''}
                    ${alert.location ? `<p><strong>Meeting Location:</strong> ${alert.location}</p>` : ''}
                    <p><strong>Time:</strong> ${new Date(alert.timestamp).toLocaleString()}</p>
            `;

            if (alert.lastLocation && alert.lastLocation.lat) {
                detailHTML += `
                    </div>
                    <div class="location-status">
                        <strong>√∞≈∏‚Äú¬ç Last Known Location</strong><br>
                        <small>GPS Coordinates: ${alert.lastLocation.lat.toFixed(6)}, ${alert.lastLocation.lng.toFixed(6)}</small>
                    </div>
                    <div class="map-container" id="alertMapContainer"></div>
                    <div class="map-info">
                        <a href="https://www.google.com/maps?q=${alert.lastLocation.lat},${alert.lastLocation.lng}" target="_blank" 
                           style="color: #0085CA; font-weight: 600; display: inline-block; margin-top: 10px;">
                           √∞≈∏‚Äú¬ç Open in Google Maps √¢‚Ä†‚Äô
                        </a>
                    </div>
                `;
            } else {
                detailHTML += `
                    <p style="color: #999; margin-top: 10px;">No GPS location available</p>
                    </div>
                `;
            }

            document.getElementById('alertDetailContent').innerHTML = detailHTML;
            document.getElementById('alertDetailModal').classList.add('active');

            if (alert.lastLocation && alert.lastLocation.lat) {
                setTimeout(() => {
                    const alertMap = L.map('alertMapContainer').setView([alert.lastLocation.lat, alert.lastLocation.lng], 15);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '√Ç¬© OpenStreetMap contributors',
                        maxZoom: 19
                    }).addTo(alertMap);

                    L.marker([alert.lastLocation.lat, alert.lastLocation.lng]).addTo(alertMap)
                        .bindPopup(`${alert.userName}'s Last Known Location`)
                        .openPopup();

                    setTimeout(() => alertMap.invalidateSize(), 100);
                }, 100);
            }
        }

        function clearAlert(alertId) {
            const alert = alerts.find(a => a.id === alertId);
            if (!alert) return;
            
            const meeting = meetings.find(m => m.id === alert.meetingId);
            
            if (meeting && meeting.pin) {
                const enteredPin = prompt('Enter the 4-digit Safety PIN from the SMS message to clear this alert:');
                
                if (!enteredPin) {
                    return;
                }
                
                if (enteredPin !== meeting.pin) {
                    alert('√¢≈ì‚Äì Incorrect PIN. Please check the PIN sent in the SMS message and try again.');
                    return;
                }
                
                // Mark alert as cleared in global alerts array
                const alertIndex = alerts.findIndex(a => a.id === alertId);
                if (alertIndex !== -1) {
                    alerts[alertIndex].cleared = true;
                    alerts[alertIndex].clearedAt = new Date().toISOString();
                    alerts[alertIndex].clearedBy = 'contact_pin';
                    saveAlertsGlobally();
                }
                
                if (!currentUser.clearedAlerts) currentUser.clearedAlerts = [];
                currentUser.clearedAlerts.push(alertId);

                const userIndex = users.findIndex(u => u.id === currentUser.id);
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                loadAlerts();
                updateCurrentMeetingAlert();
                alert('√¢≈ì‚Ä¶ Alert cleared successfully. PIN verified.');
            } else {
                if (!confirm('Mark this alert as cleared?')) {
                    return;
                }

                if (!currentUser.clearedAlerts) currentUser.clearedAlerts = [];
                currentUser.clearedAlerts.push(alertId);

                const userIndex = users.findIndex(u => u.id === currentUser.id);
                users[userIndex] = currentUser;
                localStorage.setItem('users', JSON.stringify(users));
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                loadAlerts();
                updateCurrentMeetingAlert();
                alert('Alert cleared from your view.');
            }
        }

        if ('Notification' in window) {
            Notification.requestPermission();
        }

        window.onload = init;
    </script>
</body>
</html>
